[
  {
    "id": "zjj-m54b",
    "title": "all: Clap argument errors return plain text instead of JSON",
    "description": "## EARS Requirement\n\n**WHEN** the user runs any zjj command with `--json` flag AND provides invalid/missing arguments\n**THE SYSTEM SHALL** output a JSON error response instead of clap's plain text error\n**SO THAT** automation tools can consistently parse all command outputs\n\n## Current Behavior (BUG)\n\nClap errors bypass JSON formatting:\n\n```bash\n$ zjj add --json\nerror: the following required arguments were not provided:\n  \u003cname\u003e\n\nUsage: zjj add [OPTIONS] \u003cname\u003e\n\nFor more information, try '--help'.\n```\n\n## Expected Behavior\n\n```json\n{\n  \"success\": false,\n  \"error\": {\n    \"code\": \"INVALID_ARGUMENT\",\n    \"message\": \"Missing required argument: \u003cname\u003e\",\n    \"exit_code\": 1,\n    \"usage\": \"zjj add [OPTIONS] \u003cname\u003e\"\n  }\n}\n```\n\n## Invariants\n\n- INV-1: ANY command with `--json` MUST return JSON, even for argument errors\n- INV-2: Clap errors MUST be caught and converted to JSON format\n- INV-3: Error JSON MUST include usage hint\n- INV-4: Exit code MUST be non-zero for errors\n\n## Testing Strategy\n\n### Unit Tests\n```rust\n#[test]\nfn test_missing_arg_returns_json() {\n    let output = run_command(\u0026[\"add\", \"--json\"]);\n    let json: Value = serde_json::from_str(\u0026output).unwrap();\n    assert_eq!(json[\"success\"], false);\n    assert!(json[\"error\"][\"message\"].as_str().unwrap().contains(\"required\"));\n}\n\n#[test]\nfn test_unknown_flag_returns_json() {\n    let output = run_command(\u0026[\"add\", \"--json\", \"--invalid-flag\"]);\n    let json: Value = serde_json::from_str(\u0026output).unwrap();\n    assert_eq!(json[\"error\"][\"code\"], \"INVALID_ARGUMENT\");\n}\n```\n\n### Integration Tests\n- Missing required argument with --json\n- Unknown subcommand with --json\n- Invalid flag with --json\n- Extra positional arguments with --json\n\n## Edge Cases\n\n1. `--json` flag itself is misspelled\n2. Multiple invalid arguments\n3. Conflicting flags\n4. Invalid argument values (not just missing)\n\n## Manual Testing Outcome\n\n```bash\n# Test 1: Missing argument\nzjj add --json\n# Result: Plain text clap error (BUG)\n\n# Test 2: Unknown flag\nzjj add test --json --invalid\n# Result: Plain text clap error (BUG)\n\n# Test 3: Unknown subcommand\nzjj unknown --json\n# Result: Plain text clap error (BUG)\n```\n\n## Codebase Patterns to Follow\n\nPattern used in other CLIs (e.g., gh, docker):\n```rust\nfn main() {\n    let result = run();\n    if let Err(e) = result {\n        // Check if --json was requested anywhere in args\n        if std::env::args().any(|a| a == \"--json\") {\n            eprintln!(\"{}\", json!({\n                \"success\": false,\n                \"error\": {\n                    \"code\": \"INVALID_ARGUMENT\",\n                    \"message\": e.to_string()\n                }\n            }));\n        } else {\n            eprintln!(\"{}\", e);\n        }\n        std::process::exit(1);\n    }\n}\n```\n\n## Fix Approach\n\n1. Wrap clap parsing in custom error handler\n2. Check for `--json` in raw args before parsing\n3. Convert clap errors to JSON when `--json` present\n4. Use consistent error schema across all commands\n\n## Priority Justification\n\nLOW priority because:\n- Core functionality works correctly\n- Only affects malformed commands\n- Workaround: validate arguments before calling\n- Most automation validates arguments client-side",
    "status": "open",
    "priority": 3,
    "issue_type": "bug",
    "owner": "priorlewis43@gmail.com",
    "created_at": "2026-01-26T11:51:47.734279937-06:00",
    "created_by": "Lewis Prior",
    "updated_at": "2026-01-26T11:51:47.734279937-06:00"
  }
]
