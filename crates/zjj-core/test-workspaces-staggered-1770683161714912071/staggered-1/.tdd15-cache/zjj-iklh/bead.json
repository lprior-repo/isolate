[
  {
    "id": "zjj-iklh",
    "title": "clean: stdout/stderr mixing in interactive JSON mode",
    "description": "## EARS Requirement\n\n**WHEN** the user runs `zjj clean --json` in interactive mode (without --force)\n**THE SYSTEM SHALL** separate prompts (stderr) from JSON output (stdout)\n**SO THAT** JSON can be captured cleanly while prompts remain visible\n\n## Current Behavior (BUG)\n\nInteractive prompt mixes with JSON output:\n\n```bash\n$ zjj clean --json\nFound 1 stale session(s):\n  - test-orphan\n\nRemove these sessions? [y/N] {\n  \"stale_count\": 1,\n  \"removed_count\": 0,\n  \"stale_sessions\": [\n    \"test-orphan\"\n  ]\n}\n```\n\nThe prompt text appears on the same line as JSON, breaking parsing.\n\n## Expected Behavior\n\nPrompts to stderr, JSON to stdout:\n```bash\n$ zjj clean --json 2\u003e/dev/null\n{\n  \"stale_count\": 1,\n  \"removed_count\": 0,\n  \"stale_sessions\": [\"test-orphan\"],\n  \"awaiting_confirmation\": true\n}\n```\n\n## Invariants\n\n- INV-1: All JSON output MUST go to stdout\n- INV-2: All prompts/interactive text MUST go to stderr\n- INV-3: `command 2\u003e/dev/null` MUST produce valid JSON\n- INV-4: `command 2\u003e\u00261 | jq` SHOULD parse successfully (prompt on separate line)\n\n## Testing Strategy\n\n### Unit Tests\n```rust\n#[test]\nfn test_clean_json_stdout_only() {\n    let (stdout, stderr) = run_clean_json_interactive();\n    let json: Value = serde_json::from_str(\u0026stdout).unwrap();\n    assert!(stderr.contains(\"Remove these sessions?\"));\n    assert!(!stdout.contains(\"Remove\"));\n}\n```\n\n### Integration Tests\n- Clean with --json captures stdout only\n- Clean with --json --force has no prompts\n- Piping clean --json to jq succeeds\n\n## Edge Cases\n\n1. Multiple prompts during operation\n2. Progress indicators\n3. Warning messages\n4. Very long session names wrapping\n\n## Manual Testing Outcome\n\n```bash\n# Test 1: Capture stdout only\nzjj clean --json 2\u003e/dev/null\n\n# Result: Mixed output (BUG)\n# JSON contains prompt text\n\n# Test 2: Parse with jq\nzjj clean --json 2\u003e\u00261 | jq .\n\n# Result: Parse error due to mixed content\n```\n\n## Codebase Patterns to Follow\n\nStandard Rust pattern for stderr prompts:\n```rust\nuse std::io::{self, Write};\n\n// Prompt to stderr\neprint!(\"Remove these sessions? [y/N] \");\nio::stderr().flush()?;\n\n// JSON to stdout\nprintln!(\"{}\", serde_json::to_string_pretty(\u0026response)?);\n```\n\n## Fix Approach\n\n1. Use `eprintln!` for all interactive prompts\n2. Flush stderr before reading input\n3. Ensure JSON output uses `println!` only\n4. Add test to verify stdout/stderr separation\n\n## Priority Justification\n\nLOW priority because:\n- Only affects interactive mode with --json (uncommon combo)\n- Workaround: use --force to skip prompts\n- Workaround: redirect stderr\n- Core JSON functionality works correctly",
    "status": "open",
    "priority": 3,
    "issue_type": "bug",
    "owner": "priorlewis43@gmail.com",
    "created_at": "2026-01-26T11:51:48.262757792-06:00",
    "created_by": "Lewis Prior",
    "updated_at": "2026-01-26T11:51:48.262757792-06:00"
  }
]
