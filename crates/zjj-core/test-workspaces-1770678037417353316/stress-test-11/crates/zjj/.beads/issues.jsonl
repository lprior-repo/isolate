{"id":"bd-142","title":"cli: Fix bookmark list JSON serialization error","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- Bookmark list response structure is wrong\n- Serialization fails when trying to flatten a sequence\n\n## Open Questions\n- What is the correct response structure for bookmark list?\n- Are there other commands with similar serialization issues?\n\n## Assumptions\n- Response likely has a Vec that needs different serialization strategy\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- ALL --json OUTPUT SHALL BE VALID JSON\n- JSON RESPONSES SHALL FOLLOW STANDARD SCHEMA\n\n## Event-Driven Requirements\n- WHEN WHEN user runs zjj bookmark list --json, THE SYSTEM SHALL THE SYSTEM SHALL return valid JSON array or object\n\n## Unwanted Behaviors\n- IF IF --json flag is used, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT return serialization error, BECAUSE JSON output is for programmatic consumption\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- zjj is initialized\n- bookmarks may exist\n\n## Postconditions\n- zjj bookmark list --json returns valid JSON\n- Response follows standard schema with $schema field\n\n## Invariants\n- All --json output must be valid JSON\n- JSON must be parseable by standard JSON parsers\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj/src/commands/bookmark.rs\n- crates/zjj/src/types.rs\n- crates/zjj/src/json.rs\n\n## Patterns to Find\n- bookmark list response type\n- JSON serialization macros\n- flatten attribute usage\n\n## Questions to Answer\n- What is the current response structure?\n- How should bookmark list be serialized?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- zjj bookmark list --json returns valid JSON array\n- zjj bookmark list --json includes $schema field\n\n## Error Paths\n- zjj bookmark list --json never returns serialization error\n\n## Edge Cases\n- Empty bookmark list returns empty JSON array\n- Bookmarks with special characters serialize correctly\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: cli: Fix bookmark list JSON serialization error\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Read bookmark.rs to see response structure\n- Check how flatten is used\n- Review other list commands for correct pattern\n\n## Phase 1: Tests\n- Write test: zjj bookmark list --json returns valid JSON\n- Write test: empty list returns []\n\n## Phase 2: Implementation\n- Fix response structure to be serializable\n- Remove or fix incorrect flatten usage\n- Ensure $schema field is included\n\n## Phase 3: Verification\n- Test bookmark list --json manually\n- Test with empty bookmarks\n- Test with multiple bookmarks\n\n## Phase 4: Integration\n- Verify all JSON commands return valid JSON\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- zjj bookmark list --json returns error 'can only flatten structs and maps (got a sequence)'. Response type has incorrect structure for JSON serialization.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj/src/commands/bookmark.rs\n- crates/zjj/src/types.rs\n\n## Similar Issues\n- Other list commands may have same issue\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.525093879Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.525093879Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-2kd","title":"coordination: Fix unlock succeeds for non-existent sessions","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- Unlock does not verify session exists\n- Returns success even when nothing was unlocked\n\n## Open Questions\n- Should unlock be idempotent or should it verify existence?\n\n## Assumptions\n- Unlock should verify session exists before succeeding\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- UNLOCK SHALL ONLY SUCCEED FOR EXISTING SESSIONS\n- LOCK OPERATIONS SHALL BE ACCURATE\n\n## Event-Driven Requirements\n- WHEN WHEN user runs zjj unlock nonexistent, THE SYSTEM SHALL THE SYSTEM SHALL return error (non-zero exit)\n\n## Unwanted Behaviors\n- IF IF session does not exist, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT report success, BECAUSE false positives break coordination\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- Session may or may not exist\n\n## Postconditions\n- Unlock succeeds only if session exists and is locked\n- Unlock fails if session does not exist\n\n## Invariants\n- Exit code 0 only if operation actually succeeded\n- No false positive success\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj/src/commands/lock.rs\n- crates/zjj-core/src/coordination.rs\n\n## Patterns to Find\n- unlock implementation\n- session existence check\n\n## Questions to Answer\n- How are sessions tracked?\n- How does unlock check if session exists?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- zjj unlock existing-locked-session succeeds\n\n## Error Paths\n- zjj unlock nonexistent-session returns exit code 1\n\n## Edge Cases\n- zjj unlock existing-unlocked-session behavior\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: coordination: Fix unlock succeeds for non-existent sessions\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Read unlock command implementation\n- Check how session existence is verified\n\n## Phase 1: Tests\n- Write test: unlock nonexistent returns exit code 1\n- Write test: unlock existing returns exit code 0\n\n## Phase 2: Implementation\n- Add session existence check to unlock\n- Return error if session does not exist\n\n## Phase 3: Verification\n- Test unlock manually with existing and non-existent sessions\n\n## Phase 4: Integration\n- Verify all lock operations validate session existence\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- zjj unlock nonexistent-session returns exit code 0 for sessions that don't exist. False positive success. Mutual exclusion guarantees broken.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj/src/commands/lock.rs\n- crates/zjj-core/src/coordination.rs\n\n## Similar Issues\n- claim may have similar issue (CRITICAL-012)\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.578194051Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.578194051Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-2l1","title":"cli: Fix pane focus command clap panic","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- Same root cause as CRITICAL-001\n\n## Assumptions\n- Fix is identical to CRITICAL-001 - correct ArgAction\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- PANE MANAGEMENT SHALL NOT PANIC\n- ALL PANE COMMANDS SHALL execute gracefully\n\n## Event-Driven Requirements\n- WHEN WHEN user runs zjj pane focus <session>, THE SYSTEM SHALL THE SYSTEM SHALL focus the pane or return error\n\n## Unwanted Behaviors\n- IF IF pane command is invoked, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT panic with ArgAction error, BECAUSE pane management is user-facing feature\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- zjj is initialized\n- pane command is configured\n\n## Postconditions\n- zjj pane focus <session> executes without panic\n- Focus operation succeeds or fails gracefully\n\n## Invariants\n- Exit code 0 on success, non-zero on failure\n- No panic shall occur\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj/src/commands/pane.rs\n- crates/zjj/src/cli.rs\n\n## Patterns to Find\n- pane focus command definition\n- ArgAction for pane flags\n\n## Questions to Answer\n- What flags does pane focus accept?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- zjj pane focus test-session focuses the pane\n- zjj pane focus with valid session succeeds\n\n## Error Paths\n- zjj pane focus nonexistent-session returns exit code 1 without panic\n\n## Edge Cases\n- zjj pane focus with no arguments shows help\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: cli: Fix pane focus command clap panic\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Check pane focus command definition\n- Identify misconfigured ArgAction\n\n## Phase 1: Tests\n- Write test: zjj pane focus does not panic\n\n## Phase 2: Implementation\n- Fix ArgAction for affected flags in pane command\n\n## Phase 3: Verification\n- Test pane focus manually\n\n## Phase 4: Integration\n- Verify with moon run :quick\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- zjj pane focus test-session panics with same clap ArgAction error as CRITICAL-001. The --contract flag (or similar flag) has incorrect ArgAction configuration.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj/src/commands/pane.rs\n- crates/zjj/src/cli.rs\n\n## Similar Issues\n- CRITICAL-001, CRITICAL-005 - same pattern\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.496391598Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.496391598Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-35d","title":"database: Add missing agents and broadcasts tables to init","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- Database initialization is incomplete\n- agents and broadcasts tables are missing from schema\n\n## Open Questions\n- What is the correct schema for agents and broadcasts tables?\n- Are there migrations that need to be added?\n\n## Assumptions\n- Schema exists in code but tables not created during init\n- Need to add table creation to init command\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- ZJJ INIT SHALL CREATE ALL REQUIRED TABLES\n- ALL DATABASE TABLES SHALL BE CREATED ON INIT\n\n## Event-Driven Requirements\n- WHEN WHEN user runs zjj init, THE SYSTEM SHALL THE SYSTEM SHALL create complete database schema\n- WHEN WHEN user runs zjj agents register, THE SYSTEM SHALL THE SYSTEM SHALL successfully register agent\n\n## Unwanted Behaviors\n- IF IF database schema is incomplete, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT fail on first use, BECAUSE init should prepare all required tables\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- Running zjj init in empty directory\n\n## Postconditions\n- All required tables exist (issues, dependencies, events, agents, broadcasts, etc.)\n- zjj agents register works immediately after init\n\n## Invariants\n- Database shall be fully functional after init\n- No table shall be missing\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj-core/src/database/schema.rs\n- crates/zjj/src/commands/init.rs\n- crates/zjj-core/src/database/mod.rs\n\n## Patterns to Find\n- table creation SQL\n- database initialization\n- migrations\n\n## Questions to Answer\n- What is the schema for agents table?\n- What is the schema for broadcasts table?\n- Where are table definitions?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- zjj init creates all tables including agents and broadcasts\n- zjj agents register succeeds immediately after init\n\n## Error Paths\n- zjj init does not fail with missing table error\n\n## Edge Cases\n- zjj init on existing database does not duplicate tables\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: database: Add missing agents and broadcasts tables to init\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Find schema definitions for agents and broadcasts tables\n- Check existing init code to see what tables are created\n- Review database initialization logic\n\n## Phase 1: Tests\n- Write test: zjj init creates agents table\n- Write test: zjj init creates broadcasts table\n- Write test: zjj agents register works after init\n\n## Phase 2: Implementation\n- Add agents table creation to init\n- Add broadcasts table creation to init\n- Ensure tables have correct schema\n\n## Phase 3: Verification\n- Test fresh install: zjj init && zjj agents register\n- Verify tables exist with sqlite3\n\n## Phase 4: Integration\n- Run moon run :test to verify no regressions\n- Test all commands that use agents table\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- zjj init does not create agents or broadcasts tables. zjj agents register fails with 'no such table: agents' on fresh installs. Agent registration completely broken.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj-core/src/database/schema.rs\n- crates/zjj/src/commands/init.rs\n- crates/zjj/src/commands/agents.rs\n\n## Similar Issues\n- Other tables may be missing from init\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.533853560Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.533853560Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-3pk","title":"cli: Fix queue command type mismatch panic","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- Queue is completely broken - all subcommands affected\n\n## Open Questions\n- What type should priority be defined as?\n\n## Assumptions\n- Priority should probably be a String or enum, not mismatched types\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- THE QUEUE SYSTEM SHALL provide critical workflow coordination\n- ALL QUEUE COMMANDS SHALL execute without panic\n\n## Event-Driven Requirements\n- WHEN WHEN user runs any zjj queue subcommand, THE SYSTEM SHALL THE SYSTEM SHALL execute or return graceful error\n\n## Unwanted Behaviors\n- IF IF queue command is invoked, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT abort with type error, BECAUSE queue coordination is core to multi-agent workflows\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- zjj is initialized\n- queue command has subcommands defined\n\n## Postconditions\n- All zjj queue subcommands execute without panic\n- Type definitions match between clap and access code\n\n## Invariants\n- Type definition must be consistent across clap and usage\n- No downcast errors shall occur\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj/src/commands/queue.rs\n- crates/zjj/src/cli.rs\n\n## Patterns to Find\n- priority argument definition\n- queue subcommand structure\n\n## Questions to Answer\n- What type is priority in the actual code?\n- How is priority accessed in the command handler?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- zjj queue --list --json returns valid JSON\n- zjj queue --stats returns exit code 0\n- zjj queue --next shows next item\n\n## Error Paths\n- Invalid queue arguments return exit code 2 without panic\n\n## Edge Cases\n- zjj queue with no arguments shows help\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: cli: Fix queue command type mismatch panic\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Read queue.rs to understand priority type usage\n- Check clap definition of priority argument\n\n## Phase 1: Tests\n- Write test: zjj queue --list does not panic\n- Write test: all queue subcommands are callable\n\n## Phase 2: Implementation\n- Fix clap type definition for priority to match usage\n- Ensure type consistency across all queue subcommands\n\n## Phase 3: Verification\n- Test all queue subcommands manually\n- Verify no type errors\n\n## Phase 4: Integration\n- Run moon run :ci to verify full suite passes\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- All queue subcommands panic with 'Mismatch between definition and access of priority. Could not downcast to TypeId'. This is a clap type definition error where the priority argument is defined incorrectly.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj/src/commands/queue.rs\n- crates/zjj/src/cli.rs\n- crates/zjj-core/src/queue/mod.rs\n\n## Similar Issues\n- Other clap type mismatches may exist\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.488499568Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.488499568Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-49t","title":"cli: Fix exit code violation - errors return exit 0","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- Error response JSON has exit_code field but actual exit code is 0\n- This is a contract violation\n\n## Open Questions\n- How many commands have this issue?\n- Where should exit codes be set - in main or in each command?\n\n## Assumptions\n- Need to ensure main() returns non-zero when JSON success=false\n- May need to audit all commands\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- FAILED COMMANDS SHALL RETURN NON-ZERO EXIT CODE\n- EXIT CODES SHALL MATCH JSON RESPONSE\n\n## Event-Driven Requirements\n- WHEN WHEN command fails, THE SYSTEM SHALL THE SYSTEM SHALL return exit code 1 (or error-specific code)\n\n## Unwanted Behaviors\n- IF IF command reports error in JSON, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT return exit code 0, BECAUSE scripts rely on exit codes to detect failure\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- Command is invoked with invalid arguments\n\n## Postconditions\n- Exit code is non-zero when command fails\n- Exit code matches JSON response exit_code field\n\n## Invariants\n- Exit code 0 = success\n- Exit code non-zero = failure\n- Exit codes must be consistent with JSON\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj/src/main.rs\n- crates/zjj/src/json.rs\n- crates/zjj/src/commands/*.rs\n\n## Patterns to Find\n- exit code handling\n- error propagation\n- main return value\n\n## Questions to Answer\n- How does main() determine exit code?\n- Do commands return Result or exit codes?\n- Where is the disconnect?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- All commands return exit 0 on success\n\n## Error Paths\n- zjj add with invalid name returns exit 1\n- zjj add with 10000 char name returns exit 1\n- All error cases return non-zero exit\n\n## Edge Cases\n- JSON exit_code field matches actual exit code\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: cli: Fix exit code violation - errors return exit 0\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Read main.rs to understand exit code handling\n- Check how JSON response error field is set\n- Identify where exit code is lost\n\n## Phase 1: Tests\n- Write test: all error cases return non-zero exit\n- Write test: JSON exit_code matches actual exit code\n\n## Phase 2: Implementation\n- Fix main() to return non-zero when success=false\n- Ensure all error paths propagate correctly\n- Add integration test for exit codes\n\n## Phase 3: Verification\n- Test all commands: verify error cases return non-zero\n- Test with shell: echo $? after each error case\n\n## Phase 4: Integration\n- Run full test suite\n- Audit all commands for exit code consistency\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- zjj add $(python3 -c 'print(\"a\"*10000)') --json reports error in JSON but returns exit code 0. Scripts think command succeeded when it failed. Affects multiple commands.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj/src/main.rs\n- crates/zjj/src/json.rs\n\n## Similar Issues\n- undo, revert, retry, integrity commands also have exit code violations (MAJOR bugs)\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.543213956Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.543213956Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-5ec","title":"cli: Fix clap panic in status command with --contract flag","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- This is a clap configuration issue, not a logic bug\n\n## Open Questions\n- Are there other commands with similar --contract flag issues?\n\n## Assumptions\n- Fix involves changing ArgAction to SetTrue or SetFalse\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- THE CLI SHALL NOT PANIC under any input conditions\n- THE CLI SHALL provide meaningful error messages for invalid arguments\n\n## Event-Driven Requirements\n- WHEN WHEN user runs zjj status --json, THE SYSTEM SHALL THE SYSTEM SHALL either execute successfully or return graceful error\n\n## Unwanted Behaviors\n- IF IF --contract flag is misconfigured, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT panic with abort, BECAUSE panics crash the entire CLI and provide poor UX\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- zjj is initialized\n- clap is configured for status command\n\n## Postconditions\n- zjj status --json executes without panic\n- Error is returned gracefully if arguments are invalid\n\n## Invariants\n- Exit code shall be 0 on success, non-zero on failure\n- No panic shall occur for any valid command invocation\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj/src/commands/status.rs\n- crates/zjj/src/cli.rs\n\n## Patterns to Find\n- ArgAction::Set usage for flags\n- --contract flag definition\n\n## Questions to Answer\n- What is the correct ArgAction for --contract?\n- Are there other commands with similar issues?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- zjj status --json returns valid JSON with exit code 0\n- zjj status test-session returns exit code 0\n\n## Error Paths\n- Invalid arguments return exit code 2 without panic\n- Missing arguments return exit code 2 without panic\n\n## Edge Cases\n- zjj status with multiple arguments handles gracefully\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: cli: Fix clap panic in status command with --contract flag\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Grep for all --contract flag definitions in CLI\n- Identify which commands have this flag\n\n## Phase 1: Tests\n- Write test: zjj status --json does not panic\n- Write test: zjj status with invalid args exits gracefully\n\n## Phase 2: Implementation\n- Fix ArgAction for --contract flag in status command\n- Fix ArgAction for --contract flag in all affected commands\n\n## Phase 3: Verification\n- Run all tests to verify no regressions\n- Test manually: zjj status --json\n\n## Phase 4: Integration\n- Run moon run :ci to verify no clippy warnings\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- zjj status --json panics due to incorrect clap ArgAction configuration. Error: 'arg contract's ArgAction should be one of SetTrue, SetFalse which should provide a default'. Affects status command with any arguments.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj/src/commands/status.rs\n- crates/zjj/src/commands/mod.rs\n- crates/zjj/src/cli.rs\n\n## Similar Issues\n- CRITICAL-003, CRITICAL-005 have same clap ArgAction pattern\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.479280091Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.479280091Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-8fr","title":"core: Fix workspace creation in sibling directories","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- This affects the primary zjj add workflow\n- jj commands need explicit repository path when run outside repo\n\n## Open Questions\n- Should we cd to repo root before running jj, or pass --repository flag?\n- Are there other commands that run jj from outside repo?\n\n## Assumptions\n- Using --repository flag is cleaner than cd\n- This pattern may affect other commands like spawn, sync\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- ZJJ SHALL CREATE WORKSPACES IN CONFIGURED DIRECTORIES\n- ALL JJ COMMANDS SHALL RUN WITH EXPLICIT REPOSITORY PATH\n\n## Event-Driven Requirements\n- WHEN WHEN user runs zjj add test-session, THE SYSTEM SHALL THE SYSTEM SHALL create workspace successfully\n\n## Unwanted Behaviors\n- IF IF workspace_dir is outside repo root, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT fail to find jj repo, BECAUSE workspace_dir configuration is valid and supported\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- zjj is initialized\n- workspace_dir is configured\n- jj repo exists\n\n## Postconditions\n- Workspace is created in configured directory\n- jj commands execute with correct repository context\n\n## Invariants\n- All jj invocations must specify repository path explicitly\n- jj commands must not assume CWD is repo root\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj-core/src/workspace.rs\n- crates/zjj/src/commands/add.rs\n- crates/zjj/src/config.rs\n\n## Patterns to Find\n- jj command invocation\n- workspace_dir usage\n- repository path handling\n\n## Questions to Answer\n- How is workspace_dir configured and read?\n- Where are jj commands invoked?\n- Is there a utility function for running jj commands?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- zjj add test-session creates workspace in configured directory\n- zjj add succeeds with workspace_dir = '../repo__workspaces'\n\n## Error Paths\n- zjj add with invalid name returns exit code 1\n- zjj add with duplicate name returns exit code 1\n\n## Edge Cases\n- zjj add with absolute path workspace_dir works\n- zjj add with relative path workspace_dir works\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: core: Fix workspace creation in sibling directories\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Read workspace.rs to understand jj invocation\n- Identify all places jj commands are run\n- Check if --repository flag support exists\n\n## Phase 1: Tests\n- Write test: zjj add creates workspace in sibling directory\n- Write test: zjj add with various workspace_dir configurations\n\n## Phase 2: Implementation\n- Add helper function to run jj with explicit --repository flag\n- Update all jj invocations to use helper\n- Ensure repository path is passed correctly\n\n## Phase 3: Verification\n- Test zjj add with sibling directory config\n- Test with absolute and relative workspace_dir\n- Verify workspace is functional\n\n## Phase 4: Integration\n- Run moon run :test to verify no regressions\n- Test all commands that invoke jj (sync, status, spawn, etc.)\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- When workspace_dir = '../{repo}__workspaces', zjj add fails with 'There is no jj repo in .'. Root cause: zjj runs jj commands from workspace sibling directory without proper --repository flag. Core workflow completely broken.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj-core/src/workspace.rs\n- crates/zjj/src/commands/add.rs\n- crates/zjj/src/commands/spawn.rs\n- crates/zjj/src/commands/sync.rs\n\n## Similar Issues\n- spawn, sync commands likely have same issue\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.505783033Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.505783033Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-adl","title":"cli: Fix spawn command clap panic","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- Same clap ArgAction misconfiguration\n\n## Assumptions\n- Fix is identical to other clap panic bugs\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- SPAWN COMMAND SHALL NOT PANIC\n- AGENT SPAWN WORKFLOW SHALL WORK\n\n## Event-Driven Requirements\n- WHEN WHEN user runs zjj spawn, THE SYSTEM SHALL THE SYSTEM SHALL spawn agent or return graceful error\n\n## Unwanted Behaviors\n- IF IF spawn command is invoked, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT panic, BECAUSE spawn workflow is critical for multi-agent development\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- zjj is initialized\n- spawn command is configured\n\n## Postconditions\n- zjj spawn executes without panic\n- Spawn operation succeeds or fails gracefully\n\n## Invariants\n- Exit code 0 on success, non-zero on failure\n- No panic shall occur\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj/src/commands/spawn.rs\n- crates/zjj/src/cli.rs\n\n## Patterns to Find\n- spawn command flags\n- ArgAction configurations\n\n## Questions to Answer\n- What flags does spawn accept?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- zjj spawn <bead-id> spawns agent workspace\n\n## Error Paths\n- zjj spawn with invalid args returns exit code 2 without panic\n\n## Edge Cases\n- zjj spawn with no args shows help\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: cli: Fix spawn command clap panic\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Check spawn command definition\n- Identify misconfigured ArgAction\n\n## Phase 1: Tests\n- Write test: zjj spawn does not panic\n\n## Phase 2: Implementation\n- Fix ArgAction for affected flags\n\n## Phase 3: Verification\n- Test spawn manually\n\n## Phase 4: Integration\n- Verify with moon run :quick\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- zjj spawn bd-30u --no-auto-merge --no-auto-cleanup panics with same clap ArgAction error. Same root cause as CRITICAL-001, CRITICAL-003.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj/src/commands/spawn.rs\n- crates/zjj/src/cli.rs\n\n## Similar Issues\n- CRITICAL-001, CRITICAL-003 - same pattern\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.515609474Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.515609474Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-gwf","title":"cli: Fix duplicate JSON output in rename command","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- Rename command outputs multiple JSON objects\n- There are duplicate success fields\n\n## Open Questions\n- Why are two JSON objects being output?\n- Is this a print statement issue?\n\n## Assumptions\n- Command is printing JSON twice\n- Need to ensure only one JSON response\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- EACH COMMAND SHALL OUTPUT EXACTLY ONE JSON OBJECT\n- JSON OUTPUT SHALL BE VALID AND PARSEABLE\n\n## Event-Driven Requirements\n- WHEN WHEN user runs command with --json, THE SYSTEM SHALL THE SYSTEM SHALL output exactly one valid JSON object\n\n## Unwanted Behaviors\n- IF IF --json flag is used, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT output multiple JSON objects, BECAUSE JSON parsers expect single object\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- Command is invoked with --json flag\n\n## Postconditions\n- Exactly one JSON object is output\n- No duplicate keys in JSON\n- JSON is parseable\n\n## Invariants\n- One command = one JSON response\n- STDOUT contains only the JSON response\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj/src/commands/rename.rs\n- crates/zjj/src/json.rs\n\n## Patterns to Find\n- JSON output\n- print statements\n- response formatting\n\n## Questions to Answer\n- Where are the two JSON objects coming from?\n- Is there a debug print?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- zjj rename old new --json outputs exactly one JSON object\n- Rename success outputs valid JSON once\n\n## Error Paths\n- zjj rename nonexistent new --json outputs exactly one error JSON\n\n## Edge Cases\n- JSON has no duplicate keys\n- JSON parses successfully with jq\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: cli: Fix duplicate JSON output in rename command\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Read rename.rs to find all JSON output\n- Identify why two objects are printed\n\n## Phase 1: Tests\n- Write test: rename outputs exactly one JSON object\n- Write test: no duplicate keys in JSON\n\n## Phase 2: Implementation\n- Remove duplicate JSON output\n- Ensure only one print_json call\n- Fix duplicate success field if present\n\n## Phase 3: Verification\n- Test rename --json manually\n- Verify with jq that JSON is valid\n\n## Phase 4: Integration\n- Check other commands for similar issues\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- zjj rename nonexistent new-name --json outputs two JSON objects with duplicate 'success' keys. Invalid JSON that breaks parsers.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj/src/commands/rename.rs\n\n## Similar Issues\n- Other commands may have duplicate output issue (MAJOR-021)\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.552856759Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.552856759Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-tg9","title":"security: Fix yield allows releasing other processes' locks","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- Yield does not verify holder PID\n- Any process can yield any lock\n\n## Open Questions\n- Where is holder PID stored?\n- How to verify current process owns the lock?\n\n## Assumptions\n- Lock holder PID is stored but not checked on yield\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- ONLY LOCK HOLDER SHALL YIELD THEIR LOCK\n- MUTUAL EXCLUSION SHALL BE ENFORCED\n\n## Event-Driven Requirements\n- WHEN WHEN process B tries to yield process A's lock, THE SYSTEM SHALL THE SYSTEM SHALL return error (permission denied)\n\n## Unwanted Behaviors\n- IF IF process does not hold the lock, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT allow yield, BECAUSE this breaks mutual exclusion and is a security vulnerability\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- Lock is held by some process\n\n## Postconditions\n- Only lock holder can yield their own lock\n- Yield by non-holder returns error\n\n## Invariants\n- PID is checked on yield\n- Lock holder cannot be spoofed\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj/src/commands/lock.rs\n- crates/zjj-core/src/coordination.rs\n\n## Patterns to Find\n- yield implementation\n- PID storage\n- lock holder tracking\n\n## Questions to Answer\n- Where is lock holder PID stored?\n- How to get current process PID?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- Process can yield its own lock\n\n## Error Paths\n- Process cannot yield lock held by different process\n- Yield by non-holder returns exit code 1\n\n## Edge Cases\n- Yield after lock expiry behavior\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: security: Fix yield allows releasing other processes' locks\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Read yield command implementation\n- Find where lock holder PID is stored\n- Check how PID is currently handled\n\n## Phase 1: Tests\n- Write test: process cannot yield another process's lock\n- Write test: process can yield its own lock\n\n## Phase 2: Implementation\n- Add PID check to yield command\n- Compare holder PID with current process PID\n- Return error if PIDs don't match\n\n## Phase 3: Verification\n- Test yield from same process (should succeed)\n- Test yield from different process (should fail)\n\n## Phase 4: Integration\n- Verify all lock operations check holder\n- Test claim, yield, unlock for PID validation\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- Process B can run zjj yield session:test-resource held by Process A. Any process can release locks held by others. Security vulnerability - breaks mutual exclusion.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj/src/commands/lock.rs\n- crates/zjj-core/src/coordination.rs\n\n## Similar Issues\n- CRITICAL-011 - unlock also has session validation issue\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.590582060Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.590582060Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"bd-ww0","title":"cli: Add schema wrapper to clean and backup JSON output","description":"# Clarifications (Section 0)\n\n## Resolved Questions\n- Clean and backup JSON don't follow standard schema\n- They output raw data instead of wrapped response\n\n## Open Questions\n- What is the correct schema for clean-response?\n- What is the correct schema for backup-response?\n\n## Assumptions\n- Need to create response structs with $schema field\n\n\n# EARS Requirements (Section 1)\n\n## Ubiquitous Requirements\n- ALL JSON OUTPUT SHALL FOLLOW STANDARD SCHEMA\n- ALL JSON RESPONSES SHALL INCLUDE $schema FIELD\n\n## Event-Driven Requirements\n- WHEN WHEN user runs command with --json, THE SYSTEM SHALL THE SYSTEM SHALL output schema-wrapped JSON\n\n## Unwanted Behaviors\n- IF IF --json flag is used, THE SYSTEM SHALL NOT THE SYSTEM SHALL NOT output raw data without schema, BECAUSE schema validation is part of JSON protocol\n\n\n# KIRK Contracts (Section 2)\n\n## Preconditions\n- Command is invoked with --json flag\n\n## Postconditions\n- JSON includes $schema field\n- JSON includes _schema_version field\n- JSON includes success field\n\n## Invariants\n- All JSON responses follow same structure\n- Schema is validateable\n\n\n# Research Requirements (Section 2.5)\n\n## Files to Read\n- crates/zjj/src/commands/clean.rs\n- crates/zjj/src/commands/backup.rs\n- crates/zjj/src/json.rs\n\n## Patterns to Find\n- JSON response structures\n- schema field definitions\n\n## Questions to Answer\n- What is the clean response schema?\n- What is the backup response schema?\n\n\n# Inversions (Section 3)\n\n## Usability Inversions\n- Panic provides poor user experience compared to graceful error\n- Users cannot distinguish between panic and application error\n\n\n# ATDD Tests (Section 4)\n\n## Happy Paths\n- zjj clean --dry-run --json includes $schema field\n- zjj backup --list --json includes $schema field\n\n## Error Paths\n- No JSON output lacks schema wrapper\n\n## Edge Cases\n- Schema can be validated against protocol\n\n\n# E2E Tests (Section 5)\n\n## Scenarios\n- Test the fix for: cli: Add schema wrapper to clean and backup JSON output\n- Verify no panic occurs\n- Verify exit codes are correct\n\n\n# Verification Checkpoints (Section 5.5)\n\n## Implementation Gate\n- [ ] Fix implemented according to specification\n- [ ] Code follows functional Rust patterns (zero unwraps)\n- [ ] No new clippy warnings\n\n\n# Implementation Tasks (Section 6)\n\n## Phase 0: Research\n- Read clean.rs and backup.rs to see current output\n- Check json.rs for schema wrapper pattern\n\n## Phase 1: Tests\n- Write test: clean --json includes schema wrapper\n- Write test: backup --json includes schema wrapper\n\n## Phase 2: Implementation\n- Create response structs with schema fields\n- Wrap output data in standard response structure\n- Update serialization\n\n## Phase 3: Verification\n- Test clean --dry-run --json has schema\n- Test backup --list --json has schema\n\n## Phase 4: Integration\n- Audit all --json commands for schema compliance\n\n\n# Failure Modes (Section 7)\n\n## Symptoms\n- zjj clean --dry-run --json and zjj backup --list --json output raw data without standard schema wrapper. Missing $schema, _schema_version, schema_type, success fields. Protocol violation.\n- Application may panic or crash\n\n## Root Causes\n- See research section for details\n\n## Debugging Commands\n```bash\n# Run with debug output\n# Add RUST_BACKTRACE=1 for full backtrace\n```\n\n\n# Anti-Hallucination (Section 7.5)\n\n## Read-Before-Write Rules\n- MUST read relevant files before making changes\n- MUST verify API existence before using\n- MUST check existing patterns before modifying\n\n\n# Context Survival (Section 7.6)\n\n## Recovery Instructions\nIf work is interrupted:\n1. Run `br show <bead-id>` to get context\n2. Read this description for full context\n3. Continue at appropriate phase\n\n\n# Completion Checklist (Section 8)\n\n## Code\n- [ ] Fix implemented\n- [ ] No clippy warnings\n- [ ] Follows functional Rust patterns\n\n## Tests\n- [ ] Unit tests added/updated\n- [ ] Manual testing completed\n- [ ] Exit codes verified\n\n## CI\n- [ ] moon run :quick passes\n- [ ] moon run :ci passes\n\n\n# Context (Section 9)\n\n## Related Files\n- crates/zjj/src/commands/clean.rs\n- crates/zjj/src/commands/backup.rs\n- crates/zjj/src/json.rs\n\n## Similar Issues\n- Other commands may lack schema wrapper (MAJOR-022)\n\n\n# AI Hints (Section 10)\n\n## Do\n- Use functional Rust patterns\n- Return Result<T, E> instead of panicking\n- Use ? operator for error propagation\n- Test before implementing\n\n## Don't\n- Don't use unwrap(), expect(), panic!, todo!\n- Don't skip error handling\n- Don't ignore clippy warnings\n\n## Constitution\n- ZERO PANICS - all panics must be fixed\n- ZERO UNWRAPS - use proper error handling\n- TEST FIRST - write tests before fixing\n- VERIFY EXIT CODES - all errors return non-zero","status":"open","priority":0,"issue_type":"bug","created_at":"2026-02-09T22:04:11.566221619Z","created_by":"lewis","updated_at":"2026-02-09T22:04:11.566221619Z","source_repo":".","compaction_level":0,"original_size":0}
