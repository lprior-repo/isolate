[
  {
    "id": "zjj-nyfv",
    "title": "sync: Duplicate JSON output when sync fails",
    "description": "## EARS Requirement\n\n**WHEN** the user runs `zjj sync \u003csession\u003e --json` and the sync operation fails\n**THE SYSTEM SHALL** output exactly ONE JSON response containing the error information\n**SO THAT** JSON output can be reliably parsed by automation tools and AI agents\n\n## Current Behavior (BUG)\n\nWhen sync fails, TWO separate JSON objects are printed:\n\n```json\n{\"$schema\":\"zjj://sync-response/v1\",\"_schema_version\":\"1.0\",\"schema_type\":\"single\",\"success\":true,\"name\":\"test-session\",\"synced_count\":0,\"failed_count\":1,\"errors\":[{\"name\":\"test-session\",\"error\":\"Failed to sync workspace with main\"}]}\n{\n  \"success\": false,\n  \"error\": {\n    \"code\": \"UNKNOWN\",\n    \"message\": \"Failed to sync workspace with main\",\n    \"exit_code\": 4\n  }\n}\n```\n\nThis breaks JSON parsing as the output is not valid JSON (two objects without array wrapper).\n\n## Expected Behavior\n\nSingle JSON response with error information embedded:\n```json\n{\n  \"$schema\": \"zjj://sync-response/v1\",\n  \"_schema_version\": \"1.0\",\n  \"schema_type\": \"single\",\n  \"success\": false,\n  \"name\": \"test-session\",\n  \"synced_count\": 0,\n  \"failed_count\": 1,\n  \"errors\": [{\"name\": \"test-session\", \"error\": \"Failed to sync workspace with main\"}],\n  \"error\": {\n    \"code\": \"SYNC_FAILED\",\n    \"message\": \"Failed to sync 1 session(s)\"\n  }\n}\n```\n\n## Invariants\n\n- INV-1: `--json` flag MUST produce exactly ONE JSON object\n- INV-2: JSON output MUST be parseable by `jq` without errors\n- INV-3: Error information MUST be in sync-response schema, NOT separate error object\n- INV-4: `success` field MUST be `false` when any session fails to sync\n\n## Testing Strategy\n\n### Unit Tests\n```rust\n#[test]\nfn test_sync_json_single_output_on_failure() {\n    let output = run_sync_with_failure();\n    let lines: Vec\u003c_\u003e = output.lines().collect();\n    assert_eq!(lines.len(), 1, \"Should output single JSON line\");\n    let json: Value = serde_json::from_str(lines[0]).unwrap();\n    assert_eq!(json[\"success\"], false);\n}\n\n#[test]\nfn test_sync_json_parseable_by_jq() {\n    let output = run_sync_with_failure();\n    // Pipe through jq and verify no parse errors\n}\n```\n\n### Integration Tests\n- Sync success: single JSON with success=true\n- Sync single failure: single JSON with success=false\n- Sync partial failure: single JSON with mixed results\n- Sync all failures: single JSON with all errors\n\n## Edge Cases\n\n1. Multiple sessions, some succeed, some fail\n2. All sessions fail\n3. Network/IO errors during sync\n4. Concurrent sync operations\n\n## Manual Testing Outcome\n\n```bash\n# Test performed:\nzjj sync test-session --json 2\u003e\u00261 | jq .\n\n# Result:\nparse error: Invalid numeric literal at line 2, column 0\n\n# Verification:\nzjj sync test-session --json 2\u003e\u00261 | wc -l\n# Output: 2 (should be 1)\n```\n\n## Codebase Patterns to Follow\n\nReference other commands that handle errors in JSON mode:\n- `crates/zjj/src/commands/add.rs` - single JSON response\n- `crates/zjj/src/commands/remove.rs` - single JSON response\n\nPattern:\n```rust\nif json_output {\n    // Build complete response including errors\n    let response = SyncResponse { \n        success: errors.is_empty(),\n        errors: errors,\n        // ...\n    };\n    println!(\"{}\", serde_json::to_string_pretty(\u0026response)?);\n    // Do NOT print additional error JSON\n    return Ok(());\n}\n```\n\n## Fix Approach\n\n1. In sync.rs, track all errors in the SyncResponse struct\n2. Set `success: false` when any errors occur\n3. Remove the separate error JSON printing path\n4. Return early after printing JSON response",
    "status": "open",
    "priority": 1,
    "issue_type": "bug",
    "owner": "priorlewis43@gmail.com",
    "created_at": "2026-01-26T11:51:46.887451609-06:00",
    "created_by": "Lewis Prior",
    "updated_at": "2026-01-26T11:51:46.887451609-06:00"
  }
]
