[
  {
    "id": "zjj-bz1g",
    "title": "sync: Hardcoded 'main' branch instead of detecting actual main branch",
    "description": "## EARS Requirement\n\n**WHEN** the user runs `zjj sync \u003csession\u003e` or `zjj sync --all`\n**THE SYSTEM SHALL** detect the actual main branch (using `jj log` or config) and rebase the session workspace onto that branch\n**SO THAT** sync works correctly in repositories using any branch naming convention (main, master, develop, default, trunk, etc.)\n\n## Current Behavior (BUG)\n\nThe sync command hardcodes \"main\" as the target branch:\n- Location: `crates/zjj/src/commands/sync.rs` line ~179\n- Always runs: `jj rebase -d main`\n- Fails with: \"Revision 'main' doesn't exist\" in repos using other conventions\n\n## Expected Behavior\n\nShould use one of:\n1. `config.main_branch` if explicitly set\n2. Auto-detect using `determine_main_branch()` from diff.rs\n3. Fall back to jj's default branch detection\n\n## Invariants\n\n- INV-1: Sync MUST work in repos with any main branch name\n- INV-2: Sync MUST respect explicit `main_branch` config setting\n- INV-3: Sync MUST NOT fail due to branch naming conventions\n- INV-4: Sync error messages MUST include actual branch name attempted\n\n## Testing Strategy\n\n### Unit Tests\n```rust\n#[test]\nfn test_sync_detects_main_branch() {\n    // Setup repo with \"develop\" as main\n    // Verify sync uses \"develop\" not \"main\"\n}\n\n#[test]\nfn test_sync_respects_config_main_branch() {\n    // Set config.main_branch = \"trunk\"\n    // Verify sync uses \"trunk\"\n}\n\n#[test]\nfn test_sync_falls_back_to_default_branch() {\n    // No config, no \"main\" - uses jj default\n}\n```\n\n### Integration Tests\n- Test sync in repo with \"main\" branch\n- Test sync in repo with \"master\" branch\n- Test sync in repo with \"develop\" branch\n- Test sync in repo with custom branch name\n\n## Edge Cases\n\n1. No main branch exists at all\n2. Multiple potential main branches\n3. Config specifies non-existent branch\n4. Branch name contains special characters\n5. Empty repository (no commits)\n\n## Manual Testing Outcome\n\n```bash\n# Test performed:\ncd /tmp/zjj-sync-test\njj git init  # Creates \"default\" branch, not \"main\"\nzjj init \u0026\u0026 zjj add test-session --no-open\nzjj sync test-session --json\n\n# Result:\n{\n  \"success\": false,\n  \"error\": {\n    \"code\": \"UNKNOWN\",\n    \"message\": \"Failed to sync workspace with main\",\n    \"exit_code\": 4\n  }\n}\n\n# Root cause:\njj rebase -d main  # Fails: \"Revision 'main' doesn't exist\"\n```\n\n## Codebase Patterns to Follow\n\nReference `crates/zjj/src/commands/diff.rs`:\n```rust\nfn determine_main_branch(repo_path: \u0026Path) -\u003e Result\u003cString\u003e {\n    // Check config first\n    // Then auto-detect from jj\n    // Fall back to common names\n}\n```\n\n## Fix Approach\n\n1. Extract `determine_main_branch()` to shared module\n2. Call it in sync.rs before rebase\n3. Add config validation for main_branch\n4. Update error messages to show actual branch name",
    "status": "in_progress",
    "priority": 0,
    "issue_type": "bug",
    "owner": "priorlewis43@gmail.com",
    "created_at": "2026-01-26T11:51:46.447967154-06:00",
    "created_by": "Lewis Prior",
    "updated_at": "2026-01-26T11:55:28.117101443-06:00"
  }
]
