---
phase: 05-integration-testing
plan: 02
subsystem: jj-integration, version-compatibility
tags: [jj, version-detection, compatibility, testing]

# Dependency graph
requires:
  - phase: 04-test-infrastructure
    provides: Comprehensive test coverage
provides:
  - JJ version detection and parsing
  - Version compatibility checking
  - Comprehensive compatibility documentation
affects: [jj-integration, init-command, error-handling, documentation]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Semantic version parsing from JJ --version output"
    - "Version comparison with minimum requirements"
    - "Graceful error messages for incompatible versions"

key-files:
  created:
    - docs/JJ_VERSION_COMPATIBILITY.md
  modified:
    - crates/zjj-core/src/jj.rs

key-decisions:
  - "Minimum supported JJ version: 0.20.0 (conservative for workspace stability)"
  - "Version format: jj X.Y.Z-<git-hash> parsed to semantic version"
  - "Compatibility checking via get_jj_version() and check_jj_version_compatible()"
  - "Comprehensive tests cover parsing, comparison, compatibility"

patterns-established:
  - "JjVersion struct for semantic versioning with PartialOrd/Ord"
  - "Version::parse() for defensive parsing of JJ output"
  - "MIN_SUPPORTED const for version requirement"

# Metrics
duration: 90min
completed: 2026-01-16
---

# Phase 05 Plan 02: JJ Version Compatibility Testing

**Implement JJ version detection and compatibility matrix - Complete TEST-04**

## Tasks

1. **Research JJ version format and breaking changes**
   - Check JJ documentation for version output
   - Review JJ changelog for breaking changes
   - Identify stable vs. deprecated commands

2. **Design version detection system**
   - JjVersion struct with major.minor.patch
   - parse() method for "jj X.Y.Z-hash" format
   - Minimum version requirement (0.20.0)

3. **Implement version functions in jj.rs**
   - get_jj_version() - Parse version from --version output
   - check_jj_version_compatible() - Verify minimum version
   - Add comprehensive error messages

4. **Add version compatibility tests**
   - test_jj_version_parse_standard_format
   - test_jj_version_parse_without_hash
   - test_jj_version_parse_invalid_*
   - test_jj_version_compatibility_*
   - test_jj_version_comparison
   - Integration tests for get_jj_version()

5. **Document compatibility matrix**
   - Create JJ_VERSION_COMPATIBILITY.md
   - Document tested versions
   - List JJ commands used by ZJJ
   - Document breaking changes avoided
   - Provide upgrade guidance

## Success Criteria

- [x] JjVersion struct implemented with semantic versioning
- [x] get_jj_version() parses JJ --version output
- [x] check_jj_version_compatible() validates minimum version
- [x] 10+ unit tests cover parsing and compatibility
- [x] Integration tests verify version detection
- [x] Comprehensive compatibility documentation created
- [x] All 202 tests passing
- [x] TEST-04 requirement complete

## Implementation Details

### JjVersion Struct

```rust
#[derive(Debug, Clone, PartialEq, Eq, PartialOrd, Ord)]
pub struct JjVersion {
    pub major: u32,
    pub minor: u32,
    pub patch: u32,
}

impl JjVersion {
    pub const MIN_SUPPORTED: JjVersion = JjVersion {
        major: 0,
        minor: 20,
        patch: 0,
    };

    pub fn parse(version_str: &str) -> Result<Self> { ... }
    pub fn is_compatible(&self) -> bool { ... }
}
```

### Version Detection

```rust
pub fn get_jj_version() -> Result<JjVersion> {
    let output = Command::new("jj").arg("--version").output()?;
    let version_str = String::from_utf8_lossy(&output.stdout).trim();
    JjVersion::parse(version_str)
}

pub fn check_jj_version_compatible() -> Result<()> {
    let version = get_jj_version()?;
    if !version.is_compatible() {
        return Err(Error::ValidationError(format!(
            "JJ version {}.{}.{} is not supported. Minimum: {}.{}.{}",
            version.major, version.minor, version.patch,
            JjVersion::MIN_SUPPORTED.major, MIN, MIN
        )));
    }
    Ok(())
}
```

### Tested Versions

- **0.36.0**: Fully tested (current development version)
- **0.20.0+**: Expected compatible (minimum supported)
- **< 0.20.0**: Not supported (lacks workspace stability)

### Commands Used (Stable Since 0.20.0)

- jj workspace add/forget/list
- jj status, jj diff --stat, jj root
- jj squash, jj rebase -d, jj git push/init
- jj --version

### Breaking Changes Avoided

- **Branch → Bookmark**: ZJJ uses workspaces, not branches
- **jj obslog**: ZJJ doesn't use obslog
- **jj unsquash**: ZJJ uses jj squash
- **git.push-branch-prefix**: ZJJ doesn't configure git prefixes

## Test Coverage

10+ version compatibility tests added:
- Standard format parsing (with git hash)
- Simple format parsing (without hash)
- Invalid format handling (wrong prefix, malformed, non-numeric)
- Compatibility checking (above/at/below minimum)
- Version comparison (PartialOrd)
- Integration tests (environment-dependent)

Total project tests: **202 passing** ✅

## Documentation

Created `docs/JJ_VERSION_COMPATIBILITY.md` with:
- Minimum requirements (0.20.0)
- Version detection process
- Tested versions matrix
- Commands used by ZJJ
- Breaking changes analysis
- Error messages
- Upgrade guidance
- Testing strategy
- Issue reporting guide

## Dependencies

**External:**
- JJ >= 0.20.0 (documented requirement)

**Internal:**
- Error types (ValidationError, JjCommandError)
- Result types throughout

## Risk Assessment

**Low Risk:**
- Workspace commands stable since 0.20.0
- Version detection is additive (no existing code affected)
- Graceful error messages for incompatibility

**Mitigation:**
- Comprehensive tests verify parsing
- Conservative minimum version (0.20.0)
- Documentation guides users to upgrade

## Next Steps

Phase 5 complete! All integration testing criteria met:
- ✅ TEST-04: JJ version compatibility
- ✅ TEST-05: Zellij integration failures
- ✅ TEST-06: Workspace cleanup atomicity

**Ready for Phase 6: Performance Foundation**
- Requires flame graph profiling
- String allocation optimization (zjj-2a4)
- Hot path analysis

---

*Phase: 05-integration-testing*
*Plan: 02*
*Completed: 2026-01-16*
