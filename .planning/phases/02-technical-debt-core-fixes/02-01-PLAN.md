---
phase: 02-technical-debt-core-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [crates/zjj/benches/config_operations.rs]
autonomous: true

must_haves:
  truths:
    - "Benchmark suite executes without errors"
    - "bench_load_config function uses correct load_config() API"
  artifacts:
    - path: "crates/zjj/benches/config_operations.rs"
      provides: "Working benchmark for config loading"
      min_lines: 120
      contains: "zjj_core::config::load_config"
  key_links:
    - from: "bench_load_config"
      to: "zjj_core::config::load_config()"
      via: "Direct function call"
      pattern: "load_config\\(\\)"
---

<objective>
Fix benchmark configuration API to use correct `load_config()` function.

Purpose: Restore performance benchmarking capability for config loading operations (DEBT-01).
Output: Working `bench_load_config` benchmark that can run in CI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/codebase/CONVENTIONS.md

# Reference the broken benchmark
@crates/zjj/benches/config_operations.rs

# Reference correct API
@crates/zjj-core/src/config.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix bench_load_config to use correct API</name>
  <files>crates/zjj/benches/config_operations.rs</files>
  <action>
    Uncomment and fix the `bench_load_config` function (lines 110-127):

    1. Remove `#[allow(dead_code)]` attribute and `const` modifier
    2. Change signature to `fn bench_load_config(c: &mut Criterion)`
    3. Uncomment the benchmark body
    4. Update to call `zjj_core::config::load_config()` (not `ConfigLoader`)
    5. The function signature is `pub fn load_config() -> Result<Config>` (takes no arguments)
    6. Use existing `create_config_files()` helper to create test environment
    7. Ensure TempDir is held in closure to prevent premature cleanup
    8. Use `black_box()` to prevent compiler optimization

    Why this works: `load_config()` is the actual public API at line 270 of config.rs. It automatically finds and loads config files from the current JJ repo. The benchmark needs to set up a temp repo environment first.

    Avoid: Don't try to pass paths to `load_config()` - it uses the current directory's `.zjj/config.toml`.
  </action>
  <verify>
    Run: `cargo bench --bench config_operations --no-run`

    Verify:
    - Compilation succeeds without errors
    - No warnings about unused functions
    - Benchmark binary builds successfully
  </verify>
  <done>
    - `bench_load_config` function is no longer dead code
    - Function calls `zjj_core::config::load_config()`
    - Benchmark compiles without errors
    - TODO comment removed (API is now correct)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bench_load_config to criterion_group</name>
  <files>crates/zjj/benches/config_operations.rs</files>
  <action>
    Find the `criterion_group!` macro at the end of the file.
    Add `bench_load_config` to the list of benchmarks.

    Example:
    ```rust
    criterion_group!(
        benches,
        bench_parse_config,
        bench_load_config,  // Add this line
        bench_serialize_config,
        // ... other benchmarks
    );
    ```

    This registers the benchmark so it actually runs when `cargo bench` is invoked.
  </action>
  <verify>
    Run: `cargo bench --bench config_operations bench_load_config 2>&1 | grep -E "(Benchmarking|config_load_full)"`

    Verify:
    - Benchmark executes (shows "Benchmarking config_load_full")
    - No errors during execution
    - Timing results are reported
  </verify>
  <done>
    - `bench_load_config` registered in criterion_group
    - Benchmark runs successfully
    - Performance metrics are reported
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo bench --bench config_operations --no-run` succeeds
- [ ] `cargo bench --bench config_operations bench_load_config` executes
- [ ] No compilation warnings in benchmark file
- [ ] DEBT-01 requirement satisfied
</verification>

<success_criteria>

- All tasks completed
- Benchmark file compiles without errors
- `bench_load_config` can be executed
- No dead code warnings
- DEBT-01 closed (benchmark uses correct API)
  </success_criteria>

<output>
After completion, create `.planning/phases/02-technical-debt-core-fixes/02-01-SUMMARY.md`
</output>
