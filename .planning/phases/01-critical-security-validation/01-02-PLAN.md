---
phase: 01-critical-security-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/zjj/src/commands/add.rs
  - crates/zjj/tests/security_path_validation.rs
autonomous: true
gap_closure: true

# Goal-backward verification
must_haves:
  truths:
    - "Absolute paths like /tmp/evil are rejected with clear error"
    - "Windows absolute paths like C:\\evil are rejected"
    - "test_reject_absolute_path_injection passes"
  artifacts:
    - path: "crates/zjj/src/commands/add.rs"
      provides: "Absolute path detection in validate_workspace_path"
      contains: "Component::RootDir"
    - path: "crates/zjj/tests/security_path_validation.rs"
      provides: "Passing test for absolute path rejection"
      exports: ["test_reject_absolute_path_injection"]
  key_links:
    - from: "validate_workspace_path"
      to: "absolute path check"
      via: "Component::RootDir detection"
      pattern: "RootDir.*Prefix"
---

<objective>
Close security gap: Reject absolute paths in workspace_dir configuration.

Purpose: Complete DEBT-04 by preventing absolute path injection attacks (e.g., /tmp/evil, C:\evil) which bypass parent directory counting.
Output: 100% passing security tests with absolute path validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-security-validation/01-01-SUMMARY.md
@.planning/phases/01-critical-security-validation/01-VERIFICATION.md

## Gap Context

From VERIFICATION.md:
- 01-01 implemented parent directory counting (blocks ../../attacks)
- test_reject_absolute_path_injection FAILS - absolute paths accepted
- Current implementation only checks Component::ParentDir, not Component::RootDir
- Gap allows: `/tmp/evil_absolute` or `C:\Windows\evil` (0 parent dirs, passes validation)

## What Already Works

From 01-01-SUMMARY.md:
- validate_workspace_path function exists at lines 168-224
- Parent dir counting prevents ../../tmp attacks
- Error messages cite DEBT-04 with clear suggestions
- 12/13 security tests pass
- Defense in depth: session name + workspace_dir validation

## The Fix Needed

Add absolute path detection BEFORE parent directory counting:
1. Check for Component::RootDir (Unix: /) or Component::Prefix (Windows: C:\)
2. Reject with security error if found
3. Update error message to mention absolute paths in "NOT allowed" section
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add absolute path check to validate_workspace_path</name>
  <files>crates/zjj/src/commands/add.rs</files>
  <action>
In validate_workspace_path function (line 168):

1. AFTER parsing components (line 178) but BEFORE parent directory counting, add absolute path check:

```rust
// Security check: Reject absolute paths (DEBT-04)
// Absolute paths bypass repository containment completely
let has_root = Path::new(config_workspace_dir)
    .components()
    .any(|c| matches!(c, Component::RootDir | Component::Prefix(_)));

if has_root {
    bail!(
        "Security: workspace_dir must be a relative path (DEBT-04)\n\
         \n\
         Configured workspace_dir: {}\n\
         \n\
         The workspace_dir configuration uses an absolute path.\n\
         This bypasses repository-relative workspace isolation.\n\
         \n\
         Allowed patterns:\n\
         • Inside repository: .jjz/workspaces, workspaces/\n\
         • One level up: ../{{}}__workspaces (default pattern)\n\
         \n\
         NOT allowed:\n\
         • Absolute Unix paths: /tmp/evil, /var/workspaces\n\
         • Absolute Windows paths: C:\\workspaces, D:\\evil\n\
         • Two or more levels up: ../../somewhere\n\
         \n\
         Security implications:\n\
         • Could write workspaces anywhere on filesystem\n\
         • Could overwrite system files\n\
         • Could bypass all repository containment\n\
         \n\
         Suggestions:\n\
         • Reset workspace_dir to default: ../{{}}__workspaces\n\
         • Or use a path within the repository: .jjz/workspaces\n\
         • Check .jjz/config.toml for tampering",
        config_workspace_dir
    );
}
```

2. Update existing "NOT allowed" section (line 197) to include absolute path examples:
   - Add bullet: "• Absolute paths: /tmp/workspaces, C:\\workspaces"
   - Keep existing bullets about parent directories

Why Component::Prefix: Windows absolute paths like C:\foo use Component::Prefix, not RootDir.
Why before parent count: Absolute paths should fail immediately, they're a distinct attack vector.
  </action>
  <verify>
moon run :check passes (type-check)
grep -A2 "Component::RootDir" crates/zjj/src/commands/add.rs shows absolute path check exists
  </verify>
  <done>validate_workspace_path rejects absolute paths before checking parent directory count</done>
</task>

<task type="auto">
  <name>Task 2: Fix failing test test_reject_absolute_path_injection</name>
  <files>crates/zjj/tests/security_path_validation.rs</files>
  <action>
The test currently exists but expects the absolute path to be rejected. With Task 1 complete, the test should now pass.

Run the test to verify:
```bash
moon run :test -- --test security_path_validation test_reject_absolute_path_injection
```

If the test still fails:
1. Check that the test is correctly setting workspace_dir to an absolute path
2. Verify the assertion expects CommandError (rejection)
3. The test should pass with no modifications needed after Task 1

If the test needs adjustment (unlikely), update assertion to match the new error message format.
  </action>
  <verify>
moon run :test -- --test security_path_validation test_reject_absolute_path_injection exits 0
Test output shows "test test_reject_absolute_path_injection ... ok"
  </verify>
  <done>test_reject_absolute_path_injection passes, verifying absolute paths are rejected</done>
</task>

<task type="auto">
  <name>Task 3: Run full security test suite</name>
  <files>crates/zjj/tests/security_path_validation.rs</files>
  <action>
Run all 13 security tests to ensure no regressions:

```bash
moon run :test -- --test security_path_validation
```

Expected: All 13 tests pass (was 12/13, now 13/13)

If any test fails:
- Review test expectations
- Ensure absolute path check doesn't interfere with valid relative paths
- Ensure error messages match test assertions
  </action>
  <verify>
moon run :test -- --test security_path_validation shows "test result: ok. 13 passed; 0 failed"
  </verify>
  <done>All 13 security tests pass, including test_reject_absolute_path_injection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] moon run :test -- --test security_path_validation passes (13/13)
- [ ] moon run :quick passes (format + lint clean)
- [ ] Absolute path check exists before parent directory count
- [ ] Error message mentions absolute paths in "NOT allowed" section
- [ ] No regressions in other test suites
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- test_reject_absolute_path_injection passes
- DEBT-04 gap closed: absolute paths rejected
- 13/13 security tests pass
- No new clippy warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security-validation/01-02-SUMMARY.md`
</output>
