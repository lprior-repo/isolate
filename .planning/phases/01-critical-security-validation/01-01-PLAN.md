---
phase: 01-critical-security-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/zjj/src/commands/add.rs
  - crates/zjj/tests/security_path_validation.rs
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "Workspace paths with `..` components are rejected with security error"
    - "Canonicalized workspace paths cannot escape intended boundaries"
    - "Security error messages provide clear guidance"
    - "Path validation tests prevent regression"
  artifacts:
    - path: "crates/zjj/src/commands/add.rs"
      provides: "Enhanced workspace path validation with canonicalization"
      contains: "validate_workspace_path|canonicalize"
      min_lines: 50
    - path: "crates/zjj/tests/security_path_validation.rs"
      provides: "Security tests for path traversal prevention"
      exports: ["test_reject_parent_directory_traversal", "test_canonicalization_boundary_check"]
      min_lines: 100
  key_links:
    - from: "add.rs run()"
      to: "validate_workspace_path()"
      via: "called before workspace creation"
      pattern: "validate_workspace_path\\("
    - from: "validate_workspace_path()"
      to: "Path::canonicalize()"
      via: "resolves path to check boundaries"
      pattern: "canonicalize\\(\\)"
    - from: "security_path_validation.rs"
      to: "jjz add command"
      via: "integration test execution"
      pattern: "jjz.*add"
---

<objective>
Eliminate directory traversal vulnerability in workspace path handling by implementing path canonicalization and boundary validation.

Purpose: Prevent attackers from using `..` components to write workspaces outside intended directories, protecting against directory escape attacks and symlink-based path traversal.

Output: Enhanced path validation function with comprehensive security tests demonstrating attack prevention.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md

# Current implementation context
@crates/zjj/src/commands/add.rs
@crates/zjj/src/session.rs

# Zero unwrap/panic policy - from CONVENTIONS.md
**Critical:** All error handling must use `Result<T, Error>` with `?` operator or combinators.
Forbidden: `.unwrap()`, `.expect()`, `panic!()`, `todo!()`, `unimplemented!()`
Enforced by: clippy deny rules at workspace level

# Build system - from CLAUDE.md
**Critical:** NEVER use `cargo` directly. Always use `moon run :task`
- `moon run :quick` - Format + lint check
- `moon run :test` - Run tests
- `moon run :build` - Release build
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement canonicalization-based path validation</name>
  <files>crates/zjj/src/commands/add.rs</files>
  <action>
Add new `validate_workspace_path` function after `validate_no_symlinks` (around line 280):

1. Accept parameters: `workspace_path: &str`, `repo_root: &Path`, `config_workspace_dir: &str`
2. Construct expected base path: `repo_root.join(config_workspace_dir)`
3. Canonicalize expected base (handle not-yet-existing paths by checking parent)
4. Canonicalize the full workspace_path (or parent if not exists)
5. Check if canonical workspace path starts with canonical base path
6. If NOT → reject with security error citing DEBT-04 requirement
7. Error message must include:
   - What was rejected (the path with `..`)
   - Why (escapes intended workspace directory)
   - Suggestion (use valid session names, check config)

**Error handling:** Use `.with_context()` for all IO operations, `.ok_or_else()` for path conversions, handle paths that don't exist yet by validating parent directory.

**Integration:** Call this function in `run()` after loading config and before `validate_no_symlinks` (around line 560, after workspace_path is constructed).

Pass: `validate_workspace_path(&workspace_path, &root, &config.workspace_dir)?;`

**Why this works:** Canonicalization resolves `..` and symlinks to absolute paths. By comparing canonical paths, we detect if the final location escapes the intended workspace_dir boundary, regardless of how many `..` components are used.
  </action>
  <verify>
1. `moon run :check` - No compilation errors
2. Function exists in add.rs with correct signature
3. Function is called in run() before workspace creation
4. Implementation uses `canonicalize()` for boundary checking
  </verify>
  <done>
- validate_workspace_path function implemented with canonicalization logic
- Function called in add command run() before workspace creation
- All error paths use Result with context, zero unwraps
- Code compiles without errors or warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive security tests</name>
  <files>crates/zjj/tests/security_path_validation.rs</files>
  <action>
Create new test file `crates/zjj/tests/security_path_validation.rs`:

**Test structure:**
```rust
use zjj::tests::common::TestHarness;

#[test]
fn test_reject_parent_directory_traversal() {
    // Attempt: session name "../../etc" → rejected by session validator
    // Attempt: modify config workspace_dir to "../../../tmp" → rejected by path validator
    // Verify: Error contains "security" or "escape" keywords
}

#[test]
fn test_reject_absolute_path_injection() {
    // Attempt: workspace_path="/tmp/evil" via manipulated config
    // Verify: Canonicalized path doesn't start with repo workspace base → rejected
}

#[test]
fn test_canonicalization_resolves_symlinks() {
    // Create symlink in workspace_dir pointing outside repo
    // Attempt: create session
    // Verify: Symlink detected by validate_no_symlinks (existing check)
}

#[test]
fn test_valid_relative_paths_allowed() {
    // Default config: "../{repo}__workspaces" is intentionally outside repo
    // Verify: Normal session creation succeeds
    // Verify: Workspace created in expected location
}

#[test]
fn test_deeply_nested_traversal_blocked() {
    // Attempt: config with "../../../../../../../../tmp"
    // Verify: Even with many ../, canonical path validation catches escape
}

#[test]
fn test_boundary_check_prevents_toctou() {
    // Create workspace_dir
    // Replace with symlink before creating session (TOCTOU attack)
    // Verify: validate_no_symlinks catches this (existing protection)
}
```

**Implementation notes:**
- Use `TestHarness` from `tests/common/mod.rs` for setup
- Each test creates isolated temp dir
- Tests use `jjz add` command integration, not unit testing private functions
- Verify both error message content AND exit code
- Follow existing test patterns from `tests/e2e_mvp_commands.rs`
  </action>
  <verify>
1. `moon run :test` - All tests pass
2. Test file contains at least 6 security-focused tests
3. Tests verify rejection of path traversal attempts
4. Tests verify valid paths still work (no false positives)
  </verify>
  <done>
- Security test file created with 6+ comprehensive tests
- Tests cover: parent directory traversal, absolute paths, symlinks, TOCTOU, deep nesting
- All tests pass and demonstrate attack prevention
- Valid use cases (default config with `..`) continue to work
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify fix against DEBT-04 requirement and run full test suite</name>
  <files>crates/zjj/src/commands/add.rs, crates/zjj/tests/security_path_validation.rs</files>
  <action>
1. Run full test suite: `moon run :test`
2. Verify all existing tests pass (no regressions)
3. Confirm new security tests are executed and pass
4. Run quick checks: `moon run :quick` (format + lint)
5. Manually verify DEBT-04 requirement satisfaction:
   - Workspace paths reject `..` components → YES (canonical path check)
   - Path canonicalization prevents symlink escapes → YES (canonicalize() usage)
   - Security tests verify boundary enforcement → YES (6+ tests)

If any failures:
- Fix breaking changes in existing code
- Adjust validation logic to handle edge cases
- Ensure no false positives for legitimate `..` in config

**Success criteria:**
- Zero test failures
- Zero clippy warnings
- Security tests demonstrate attack prevention
- DEBT-04 fully addressed
  </action>
  <verify>
1. `moon run :test` exits 0 (all tests pass)
2. `moon run :quick` exits 0 (format + lint clean)
3. New security tests visible in test output
4. No regressions in existing MVP command tests
  </verify>
  <done>
- All tests pass including new security tests
- No clippy warnings or formatting issues
- DEBT-04 requirement verified as complete
- Existing functionality unchanged (no breaking changes)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `moon run :test` passes (full test suite including security tests)
- [ ] `moon run :quick` passes (format + lint)
- [ ] DEBT-04 requirement met (workspace path validation prevents directory escape)
- [ ] New `validate_workspace_path` function exists and is called
- [ ] Security tests demonstrate attack prevention
- [ ] No regressions in existing commands (init, add, list, remove, focus)
</verification>

<success_criteria>
- All tasks completed with passing verification
- Directory traversal vulnerability eliminated via canonicalization
- Comprehensive security tests prevent regression
- Zero unwraps, zero panics (policy compliance)
- Clear security error messages guide users
- DEBT-04 marked as complete in requirements traceability
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security-validation/01-01-SUMMARY.md`
</output>
