#!/bin/bash
# Scout Agent 1 - Simple automated bead exploration

LOG_FILE="/home/lewis/src/zjj/scout-agent-1.log"
PID_FILE="/home/lewis/src/zjj/.scout-agent-1.pid"

# Check if already running
if [ -f "$PID_FILE" ]; then
  OLD_PID=$(cat "$PID_FILE")
  if ps -p "$OLD_PID" > /dev/null 2>&1; then
    echo "Already running (PID: $OLD_PID)"
    exit 1
  fi
  rm -f "$PID_FILE"
fi

echo $$ > "$PID_FILE"
trap "rm -f $PID_FILE; exit" INT TERM EXIT

log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

log "=== Scout Agent 1 started ==="

COUNTER=0
MAX_ITERATIONS=1000  # Safety limit

while [ $COUNTER -lt $MAX_ITERATIONS ]; do
  COUNTER=$((COUNTER + 1))

  # Use timeout to prevent hanging
  OUTPUT=$(timeout 10 bv --robot-next --format json 2>&1) || {
    log "bv command timed out or failed, retrying..."
    sleep 5
    continue
  }

  # Extract bead ID
  BEAD_ID=$(echo "$OUTPUT" | jq -r '.id // empty' 2>/dev/null)

  if [ -z "$BEAD_ID" ] || [ "$BEAD_ID" = "null" ]; then
    log "No valid bead, sleeping 15s..."
    sleep 15
    continue
  fi

  # Get full bead info
  BEAD_INFO=$(timeout 5 br show "$BEAD_ID" --format json 2>/dev/null || echo '[{}]')
  CURRENT_LABELS=$(echo "$BEAD_INFO" | jq -r '.[0].labels // [] | join(" ")' 2>/dev/null)

  # Skip if already processed
  if echo "$CURRENT_LABELS" | grep -qE "stage:(explored|ready-architect)"; then
    log "Bead $BEAD_ID already processed, skipping"
    sleep 3
    continue
  fi

  TITLE=$(echo "$OUTPUT" | jq -r '.title // "Unknown"' 2>/dev/null)

  # Simple size estimation from title
  WORD_COUNT=$(echo "$TITLE" | wc -w)
  if [ "$WORD_COUNT" -lt 6 ]; then
    SIZE="small"
  elif [ "$WORD_COUNT" -lt 12 ]; then
    SIZE="medium"
  else
    SIZE="large"
  fi

  log "Processing: $BEAD_ID - $TITLE (size: $SIZE)"

  # Update bead
  if br update "$BEAD_ID" --status in_progress --set-labels "stage:explored,size:$SIZE,actor:scout-1" 2>/dev/null; then
    log "✓ Updated $BEAD_ID"
  else
    log "✗ Failed to update $BEAD_ID"
  fi

  sleep 2
done

log "=== Scout Agent 1 finished ($COUNTER iterations) ==="
