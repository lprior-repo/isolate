{"id":"ISS-1000","title":"Migrate beads module from rusqlite to sqlx","description":"Root epic for migrating zjj-core beads module from synchronous rusqlite to async sqlx with connection pooling. This migration enables async/await patterns throughout the codebase while maintaining API compatibility for pure functions. Current implementation uses rusqlite blocking I/O in beads.rs and watcher.rs. Target implementation follows db.rs pattern: SQLx connection pooling, async queries, Railway-Oriented Programming. MUST pass moon run :quick and :test. Zero unwraps/panics enforced by compiler.","status":"open","priority":0,"issue_type":"epic","created_at":"2026-01-12T06:00:00Z","updated_at":"2026-01-12T06:00:00Z","children":["ISS-1001","ISS-1002","ISS-1003"]}
{"id":"ISS-1001","title":"Foundation: Update dependencies and error types for sqlx","description":"Foundation bead establishing infrastructure for sqlx migration. Add sqlx dependency with SQLite support, remove rusqlite from Cargo.toml for beads usage (watcher.rs still needs it temporarily), update BeadsError to handle sqlx::Error conversions. This enables all downstream beads to use sqlx types.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-12T06:00:00Z","updated_at":"2026-01-12T06:00:00Z","parent":"ISS-1000","complexity":2,"variants":[{"file_path":"/home/lewis/src/zjj/crates/zjj-core/Cargo.toml","description":"Add sqlx = { version = '0.7', features = ['runtime-tokio-rustls', 'sqlite'] } to dependencies. Document that rusqlite kept temporarily for watcher.rs migration."},{"file_path":"/home/lewis/src/zjj/crates/zjj-core/src/beads.rs","description":"Add impl From<sqlx::Error> for BeadsError to line 38, converting sqlx errors to BeadsError::DatabaseError. Keep existing rusqlite::Error impl for now."}],"acceptance_criteria":["sqlx dependency added to zjj-core/Cargo.toml with sqlite and runtime-tokio-rustls features","BeadsError implements From<sqlx::Error> conversion","Code compiles without errors (moon run :check passes)","No functional changes to existing code"],"postconditions":["sqlx types available for import in beads.rs","BeadsError can convert sqlx::Error to DatabaseError variant","Both rusqlite and sqlx error conversions coexist temporarily"],"fitness_function":{"test_command":"moon run :quick","expected_behavior":"Format check and clippy pass with no warnings","test_name":"N/A - compilation test"},"out_of_scope":["Removing rusqlite dependency (handled in ISS-1003)","Actual query conversions (handled in ISS-1002)","Integration tests (handled in ISS-1003)"]}
{"id":"ISS-1002","title":"Feature: Convert beads.rs query_beads to async sqlx","description":"Core feature bead converting the main beads query function from rusqlite to sqlx async. Replace Connection::open with SqlitePool, convert query_map to sqlx::query, make function async. Pure functions (filter_issues, sort_issues, paginate, etc.) remain unchanged. This is the main database access point for all beads operations.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-12T06:00:00Z","updated_at":"2026-01-12T06:00:00Z","parent":"ISS-1000","dependencies":[{"issue_id":"ISS-1002","depends_on_id":"ISS-1001","type":"blocks"}],"complexity":3,"variants":[{"file_path":"/home/lewis/src/zjj/crates/zjj-core/src/beads.rs","description":"Line 386-464: Convert query_beads to async. Replace Connection::open with SqlitePool::connect. Convert query_map to sqlx::query with fetch_all. Parse rows using row.try_get instead of row.get. Add async to function signature. Use ? operator for error propagation. Keep row parsing logic identical (lines 406-458) but use try_get."}],"acceptance_criteria":["query_beads signature is: pub async fn query_beads(workspace_path: &Path) -> Result<Vec<BeadIssue>, BeadsError>","Uses SqlitePool::connect instead of Connection::open","Uses sqlx::query with .fetch_all() instead of query_map","All row parsing uses row.try_get() with proper error conversion","No unwraps or panics in parsing logic","Pure functions (filter_issues, sort_issues, etc.) unchanged and remain non-async","All existing tests pass (lines 855-1993)"],"postconditions":["query_beads is async and returns Result<Vec<BeadIssue>>","Database connection uses sqlx connection pooling","Row parsing preserves exact same logic with try_get","Error handling uses ? operator throughout","All 30+ existing unit tests still pass"],"fitness_function":{"test_command":"moon run :test","expected_behavior":"All tests in beads.rs pass, including test_query_beads_empty_path, test_filter_issues_by_status, test_sort_issues_by_priority","test_name":"test_query_beads_empty_path"},"out_of_scope":["Changing pure function signatures (filter_issues, sort_issues remain sync)","Modifying BeadIssue struct or enums","Adding new query functions","Optimizing query performance beyond switching to sqlx"]}
{"id":"ISS-1003","title":"Integration: Update watcher.rs and all call sites to async","description":"Integration bead updating all consumers of query_beads to use async/await. Convert watcher.rs query_beads_status to async, update all command call sites (list, status, dashboard) to .await the calls. Remove rusqlite from watcher.rs and Cargo.toml. This completes the migration by wiring all async boundaries.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-12T06:00:00Z","updated_at":"2026-01-12T06:00:00Z","parent":"ISS-1000","dependencies":[{"issue_id":"ISS-1003","depends_on_id":"ISS-1002","type":"blocks"}],"complexity":3,"variants":[{"file_path":"/home/lewis/src/zjj/crates/zjj-core/src/watcher.rs","description":"Lines 163-223: Convert query_beads_status to async. Update query_all_counts to use sqlx::query. Update function signature: pub async fn query_beads_status. Remove rusqlite::Connection import. Add sqlx imports."},{"file_path":"/home/lewis/src/zjj/crates/zjj/src/commands/list.rs","description":"Update query_beads call sites to use .await. Ensure command handler is async."},{"file_path":"/home/lewis/src/zjj/crates/zjj/src/commands/status.rs","description":"Update query_beads_status call to .await. Ensure status command is async."},{"file_path":"/home/lewis/src/zjj/crates/zjj/src/commands/dashboard.rs","description":"Update beads query calls to .await, using tokio::runtime::Handle::current().block_on() if in sync TUI context."},{"file_path":"/home/lewis/src/zjj/crates/zjj-core/Cargo.toml","description":"Remove rusqlite from dependencies (no longer needed after watcher.rs conversion)."}],"acceptance_criteria":["query_beads_status in watcher.rs is async","All command handlers (list, status, dashboard) use .await for beads queries","rusqlite dependency removed from zjj-core/Cargo.toml","watcher.rs uses sqlx for query_all_counts","All integration tests pass (moon run :test)","TUI dashboard remains responsive (no blocking in event loop if using block_on)","No compilation errors or warnings (moon run :quick)"],"postconditions":["All beads database access uses sqlx async","No rusqlite imports in zjj-core crate","Commands properly await async beads queries","watcher.rs tests pass (test_query_beads_status_with_database, test_query_beads_status_no_beads)"],"fitness_function":{"test_command":"moon run :test","expected_behavior":"Full test suite passes including watcher tests and command integration tests","test_name":"test_query_beads_status_with_database"},"out_of_scope":["Changing watcher event loop architecture","Adding new beads query features","Optimizing connection pooling (use sqlx defaults)","Changing TUI framework (keep ratatui as-is)"]}
