$schema: "https://moonrepo.dev/schemas/tasks.json"

# Moon Task Configuration - MVP Pipeline
# All commands use cargo with system Rust toolchain

tasks:
  # ============================================================================
  # STAGE 1: CODE FORMATTING & LINTING
  # ============================================================================

  fmt:
    command: "cargo fmt --all --check"
    description: "Check code formatting (rustfmt)"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "rustfmt.toml"
    options:
      cache: true
      runInCI: true

  fmt-fix:
    command: "cargo fmt --all"
    description: "Auto-fix code formatting"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
    options:
      cache: false  # Never cache - always format

  clippy:
    command: "cargo clippy --workspace --all-targets --all-features -- -D clippy::unwrap_used -D clippy::expect_used -D clippy::panic -A clippy::missing_const_for_fn -A clippy::useless_conversion -W clippy::pedantic"
    description: "Lint with Clippy (strict mode for safety, allow style suggestions)"
    deps:
      - "check"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
      - ".clippy.toml"
    options:
      cache: true
      runInCI: true

  # ============================================================================
  # STAGE 2: TESTING (depends on build to avoid file lock conflicts)
  # ============================================================================

  test:
    command: "cargo nextest run --workspace --all-features --no-fail-fast -E 'not (package(zjj) & binary(drq_adversarial))'"
    description: "Run required tests (DRQ research excluded by default)"
    deps:
      - "build"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: true
      mergeArgs: "replace"  # Allow overriding with specific test filters
    env:
      CARGO_BUILD_JOBS: "16"

  test-research:
    command: "cargo nextest run --workspace --all-features --no-fail-fast -E 'package(zjj) & binary(drq_adversarial)'"
    description: "Run DRQ research lane tests (explicit opt-in)"
    deps:
      - "build"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false
      mergeArgs: "replace"
    env:
      CARGO_BUILD_JOBS: "16"

  test-doc:
    command: "cargo"
    args: "test --doc"
    description: "Run documentation tests"
    deps:
      - "build"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: true
      mergeArgs: "replace"  # Prevent duplicate --doc flags from inheritance

  coverage:
    command: "cargo tarpaulin --workspace --all-features --out Html --out Lcov --output-dir target/coverage -- --test-threads=1"
    description: "Generate test coverage report (HTML + LCOV)"
    deps:
      - "build"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    outputs:
      - "/target/coverage/index.html"
      - "/target/coverage/lcov.info"
    options:
      cache: false
      runInCI: true
    env:
      CARGO_BUILD_JOBS: "8"

  coverage-check:
    command: "cargo tarpaulin --workspace --all-features --out Lcov --output-dir target/coverage -- --test-threads=1 | grep -E '^[0-9]+\\.[0-9]+%' | awk '{ if ($1 + 0 < 80) { exit 1 } }'"
    description: "Check if coverage meets minimum threshold (80%)"
    deps:
      - "build"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: false
      runInCI: true
    env:
      CARGO_BUILD_JOBS: "8"

  # ============================================================================
  # STAGE 3: SECURITY
  # ============================================================================

  audit:
    command: "echo 'Skipping audit - cargo-audit not installed'"
    description: "Security audit of dependencies (advisory only for MVP)"
    options:
      cache: false

  # ============================================================================
  # STAGE 4: BUILD (depends on check to avoid file lock conflicts with clippy)
  # ============================================================================

  build:
    command: "cargo build --release --workspace"
    description: "Build release binaries"
    deps:
      - "check"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    outputs:
      - "/target/release/zjj"
    options:
      cache: true
      runInCI: true
    env:
      CARGO_BUILD_JOBS: "24"

  build-docs:
    command: "cargo"
    args: "doc --no-deps --document-private-items"
    description: "Generate Rust documentation"
    deps:
      - "build"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: true
      mergeArgs: "replace"  # Prevent duplicate doc flags from inheritance

  # ============================================================================
  # DOCUMENTATION VALIDATION
  # ============================================================================

  docs-check:
    command: "${MOON_WORKSPACE_ROOT}/tools/ci-docs-check.sh"
    description: "Validate zjj command documentation against implementation"
    deps:
      - "build"
    inputs:
      - "tools/ci-docs-check.sh"
      - "docs/**/*.md"
      - "target/release/zjj"
    options:
      cache: false
      runInCI: true

  tasks-check:
    command: "${MOON_WORKSPACE_ROOT}/tools/ci-tasks-check.sh"
    description: "Validate moon tasks documentation against .moon/tasks.yml"
    inputs:
      - "tools/ci-tasks-check.sh"
      - ".moon/tasks.yml"
      - "docs/**/*.md"
    options:
      cache: false
      runInCI: true

  ci-docs:
    command: "${MOON_WORKSPACE_ROOT}/tools/ci-docs-check.sh"
    description: "Alias for docs-check task (deprecated, use docs-check)"
    inputs:
      - "tools/ci-docs-check.sh"
      - "docs/**/*.md"
      - "target/release/zjj"
    options:
      cache: false
      runInCI: true

  deploy-docs:
    command: "${MOON_WORKSPACE_ROOT}/tools/deploy-docs.sh"
    description: "Deploy documentation to GitHub Pages (only runs when docs change)"
    inputs:
      - "docs/**/*.md"
      - "tools/deploy-docs.sh"
    options:
      cache: false
      runInCI: true

  deploy:
    command: "true"
    description: "Deploy to production (placeholder task)"
    options:
      cache: false
      runInCI: false

  llm-judge-fix-suggestions:
    command: "echo 'LLM judge fix suggestions - placeholder task'"
    description: "Auto-fix suggestions from LLM code review"
    options:
      cache: false
      runInCI: false

  # ============================================================================
  # COMPOSITE PIPELINES
  # ============================================================================

  quick:
    command: "cargo fmt --all --check && cargo clippy --workspace --all-targets -- -D clippy::unwrap_used -D clippy::expect_used -D clippy::panic -A clippy::missing_const_for_fn"
    description: "Fast lint check (format + clippy in one command)"
    options:
      cache: false

  ci:
    command: "bash -c 'cargo fmt --all --check && cargo clippy --workspace --all-targets -- -D warnings && cargo check --workspace --all-features && cargo nextest run --workspace --all-features --no-fail-fast'"
    description: "Full CI pipeline (all tests, all warnings fail)"
    options:
      cache: false
      runInCI: true

  # ============================================================================
  # CONVENIENCE
  # ============================================================================

  install:
    command: "mkdir -p ~/.local/bin && cargo build --release --bin zjj --package zjj && cp ${MOON_WORKSPACE_ROOT}/target/release/zjj ~/.local/bin/zjj && chmod +x ~/.local/bin/zjj && echo 'âœ… Installed zjj to ~/.local/bin/zjj'"
    description: "Install zjj binary to ~/.local/bin (system-wide)"
    options:
      cache: false
      runInCI: false

  dev:
    command: "true"
    description: "Quick development workflow: build + install"
    deps:
      - "build"
      - "install"
    options:
      cache: false

  ralph-combative-loop:
    command: "bash scripts/run_ralph_combative_loop.sh"
    description: "Run long adversarial Ralph hardening loop"
    options:
      cache: false

  clean:
    command: "cargo clean"
    description: "Clean build artifacts"
    options:
      cache: false

  check:
    command: "cargo check --workspace --all-features"
    description: "Fast type check without building"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"

  # ============================================================================
  # SECURITY & QUALITY SCANNING
  # ============================================================================

  semgrep:
    command: "/home/lewis/.local/share/mise/installs/semgrep/1.151.0/bin/semgrep"
    args: "scan --config auto --sarif --output target/semgrep-report.sarif ."
    description: "Run Semgrep OSS security and quality scan"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
    options:
      cache: true
      runInCI: true

  semgrep-json:
    command: "/home/lewis/.local/share/mise/installs/semgrep/1.151.0/bin/semgrep"
    args: "scan --config auto --json --output target/semgrep-report.json ."
    description: "Run Semgrep and output JSON report"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
    options:
      cache: true
      runInCI: true

  sonar-scan:
    command: "tools/sonar-scanner/bin/sonar-scanner"
    args: "-Dsonar.projectKey=happy-cactus -Dsonar.sources=crates -Dsonar.host.url=http://localhost:9000"
    description: "Run SonarQube Community Edition scan (requires local SonarQube server)"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
    options:
      cache: false
      runInCI: false

  security-scan:
    command: "true"
    description: "Run all security and quality scans"
    deps:
      - "~:semgrep"
      - "~:semgrep-json"
    options:
      cache: false
      runInCI: true
