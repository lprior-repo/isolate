$schema: "https://moonrepo.dev/schemas/tasks.json"

# Moon Task Configuration - MVP Pipeline
# All commands use cargo with system Rust toolchain

tasks:
  # ============================================================================
  # STAGE 1: CODE FORMATTING & LINTING
  # ============================================================================

  fmt:
    command: "cargo fmt --all --check"
    description: "Check code formatting (rustfmt)"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "rustfmt.toml"
    options:
      cache: true
      runInCI: true

  fmt-fix:
    command: "cargo fmt --all"
    description: "Auto-fix code formatting"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
    options:
      cache: false  # Never cache - always format

  clippy:
    command: "cargo clippy --workspace --all-targets --all-features -- -D warnings"
    description: "Lint with Clippy (strict mode)"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
      - ".clippy.toml"
    options:
      cache: true
      runInCI: true

  # ============================================================================
  # STAGE 2: TESTING
  # ============================================================================

  test:
    command: "cargo nextest run --workspace --all-features --no-fail-fast"
    description: "Run all tests with nextest (parallel + faster)"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: true
      mergeArgs: "replace"  # Allow overriding with specific test filters

  test-doc:
    command: "cargo test --doc --workspace"
    description: "Run documentation tests"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: true

  # ============================================================================
  # STAGE 3: SECURITY
  # ============================================================================

  audit:
    command: "echo 'Skipping audit - cargo-audit not installed'"
    description: "Security audit of dependencies (advisory only for MVP)"
    options:
      cache: false

  # ============================================================================
  # STAGE 4: BUILD
  # ============================================================================

  build:
    command: "cargo build --release --workspace"
    description: "Build release binaries"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    outputs:
      - "/target/release/zjj"
    options:
      cache: true
      runInCI: true

  build-docs:
    command: "cargo doc --no-deps --document-private-items"
    description: "Generate Rust documentation"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: true

  # ============================================================================
  # COMPOSITE PIPELINES
  # ============================================================================

  quick:
    command: "true"
    description: "Fast lint check (format + clippy in parallel)"
    deps:
      - "~:fmt"      # ~ prefix runs in parallel
      - "~:clippy"
    options:
      cache: false  # Composite task - deps handle caching

  ci:
    command: "true"
    description: "Full CI pipeline (all checks in parallel where possible)"
    deps:
      - "~:fmt"        # Parallel: formatting
      - "~:clippy"     # Parallel: linting
      - "~:test"       # Parallel: tests
      - "~:test-doc"   # Parallel: doc tests
      - "~:audit"      # Parallel: security
      - "build"        # Sequential: needs tests to pass
      - "build-docs"   # Sequential: needs clippy
    options:
      cache: false  # Composite task - deps handle caching

  # ============================================================================
  # CONVENIENCE
  # ============================================================================

  install:
    command: "mkdir -p ~/.local/bin && cargo build --release && cp target/release/zjj ~/.local/bin/zjj && chmod +x ~/.local/bin/zjj && echo '✅ Installed zjj to ~/.local/bin/zjj'"
    description: "Install zjj binary to ~/.local/bin (system-wide)"
    options:
      cache: false
      runInCI: false

  dev:
    command: "true"
    description: "Quick development workflow: build + install"
    deps:
      - "build"
      - "install"
    options:
      cache: false

  clean:
    command: "cargo clean"
    description: "Clean build artifacts"
    options:
      cache: false

  check:
    command: "cargo check --workspace --all-features"
    description: "Fast type check without building"
    inputs:
      - "crates/**/*.rs"
      - "Cargo.toml"
      - "/Cargo.lock"
    options:
      cache: true
      runInCI: false

  # ============================================================================
  # RELEASE AUTOMATION
  # ============================================================================

  release:bump:
    command: |
      if [ -z "$VERSION" ]; then
        echo "Error: VERSION environment variable required"
        echo "Usage: VERSION=0.4.0 moon run :release:bump"
        exit 1
      fi
      sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
      cargo build --release
      echo "✅ Version bumped to $VERSION"
    description: "Bump version in Cargo.toml and rebuild"
    options:
      cache: false

  release:tag:
    command: |
      VERSION=$(grep "^version = " Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
      if git rev-parse "v$VERSION" >/dev/null 2>&1; then
        echo "⚠️  Tag v$VERSION already exists"
        exit 1
      fi
      git add Cargo.toml
      git commit -m "chore: Bump version to $VERSION for release"
      git tag -a "v$VERSION" -m "Release v$VERSION"
      echo "✅ Created tag v$VERSION"
    description: "Commit version bump and create git tag"
    options:
      cache: false

  release:push:
    command: |
      VERSION=$(grep "^version = " Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
      git push origin main
      git push origin "v$VERSION"
      echo "✅ Pushed main and tag v$VERSION to origin"
    description: "Push release commit and tag to remote"
    options:
      cache: false

  release:
    command: "true"
    description: "Full release workflow: bump version, tag, and push"
    deps:
      - "ci"           # Ensure all tests pass first
      - "release:bump"  # Bump version (requires VERSION env var)
      - "release:tag"   # Create and commit tag
      - "release:push"  # Push to remote
    options:
      cache: false
