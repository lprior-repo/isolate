================================================================================
QA ENFORCER REPORT: JSONL Output Types vs CUE Schema Validation
================================================================================

EXECUTION SUMMARY
--------------------------------------------------------------------------------
Command Executed: cargo test --package zjj-core --test jsonl_schema_validation_test
Exit Code:        101 (FAILED)
Tests Run:        18
Tests Passed:     16
Tests Failed:     2
Pass Rate:        88.9%

CRITICAL FINDINGS: 2
MAJOR FINDINGS:    0
MINOR FINDINGS:    0

================================================================================
CRITICAL FINDING #1: OutputLine Enum Structure Mismatch
================================================================================

Severity:     CRITICAL
Component:    crates/zjj-core/src/output/types.rs (lines 43-59)
Impact:       Breaking change for AI agents, violates self-describing principle

ISSUE DESCRIPTION:
--------------------------------------------------------------------------------
The OutputLine enum uses newtype variants (e.g., Summary(Summary)) instead of
the tagged enum structure specified in the CUE schema.

EXPECTED (per CUE schema zjj-20260217-001):
--------------------------------------------------------------------------------
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(tag = "type")]
pub enum OutputLine {
    Summary { ... },
}

Expected JSON:
{
  "type": "summary",
  "message": "Test",
  "timestamp": 1771735069860
}

ACTUAL:
--------------------------------------------------------------------------------
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "snake_case")]
pub enum OutputLine {
    Summary(Summary),
    Session(SessionOutput),
    // ...
}

Actual JSON:
{
  "summary": {
    "type": "info",
    "message": "Test",
    "timestamp": 1771735069860
  }
}

EVIDENCE:
--------------------------------------------------------------------------------
thread 'test_output_line_enum_discriminator' (2947822) panicked at 
crates/zjj-core/tests/jsonl_schema_validation_test.rs:290:9:
OutputLine variant missing type discriminator: 
{"summary":{"message":"Test","timestamp":1771735069860,"type":"info"}}

IMPACT:
--------------------------------------------------------------------------------
  * Breaking change for AI agents expecting tagged enum structure
  * Type discriminator is nested, not at top level
  * Violates "self-describing JSON" principle
  * CUE schemas do not match implementation
  * Agents must know variant names in advance to parse

RECOMMENDED FIX:
--------------------------------------------------------------------------------
Option 1 (matches CUE schema, breaking change):
  Change to #[serde(tag = "type")] with struct variants

Option 2 (update CUE schema):
  Document nested structure and update all AI contracts

================================================================================
CRITICAL FINDING #2: ConflictAnalysis Type Field Typo
================================================================================

Severity:     CRITICAL
Component:    crates/zjj-core/src/output/types.rs (line 1113)
Impact:       Inconsistent type naming, may confuse AI agents

ISSUE DESCRIPTION:
--------------------------------------------------------------------------------
The ConflictAnalysis type_field is hardcoded as "conflictdetail" instead of
"conflict_analysis", not matching the OutputLine variant name.

ACTUAL CODE:
--------------------------------------------------------------------------------
pub fn conflict_analysis(
    session: &str,
    merge_safe: bool,
    conflicts: Vec<ConflictDetail>,
) -> Self {
    Self::ConflictAnalysis(ConflictAnalysis {
        type_field: "conflictdetail".to_string(),  // ‚Üê TYPO
        // ...
    })
}

EVIDENCE:
--------------------------------------------------------------------------------
thread 'test_conflict_analysis_serialization' (2965712) panicked at 
crates/zjj-core/tests/jsonl_schema_validation_test.rs:13:9:
Missing required field 'type' in JSON: 
{... "type":"conflictdetail" ...}

IMPACT:
--------------------------------------------------------------------------------
  * Type field doesn't match enum variant name "ConflictAnalysis"
  * Inconsistent with other OutputLine variants
  * Confuses AI agents expecting "conflict_analysis"

RECOMMENDED FIX:
--------------------------------------------------------------------------------
Change line 1113 from:
  type_field: "conflictdetail".to_string(),

To:
  type_field: "conflict_analysis".to_string(),

================================================================================
PASSING TESTS (16/18)
================================================================================

All other serialization tests PASSED:

  test_summary_serialization                       PASSED
  test_session_output_serialization                PASSED
  test_issue_serialization                         PASSED
  test_plan_serialization                          PASSED
  test_stack_serialization                         PASSED
  test_queue_summary_serialization                 PASSED
  test_queue_entry_serialization                   PASSED
  test_train_serialization                         PASSED
  test_conflict_detail_serialization               PASSED
  test_enum_value_serialization                    PASSED
  test_action_status_serialization                 PASSED
  test_train_action_serialization                  PASSED
  test_resolution_strategy_serialization           PASSED
  test_timestamp_format                            PASSED
  test_optional_fields_handling                    PASSED
  test_recovery_type_serialization                 PASSED

================================================================================
CONCLUSION
================================================================================

The JSONL output types are MOSTLY WELL-IMPLEMENTED with:
  * Proper field serialization
  * Correct enum value handling (lowercase snake_case)
  * Good optional field management
  * Accurate timestamp formatting

However, TWO CRITICAL ISSUES exist:
  1. OutputLine enum structure doesn't match CUE schema specification
  2. ConflictAnalysis type field has a typo

These issues should be resolved before production AI agents consume the output.

================================================================================
REPRODUCTION
================================================================================

Run the validation test suite:
  $ cargo test --package zjj-core --test jsonl_schema_validation_test

View detailed output:
  $ cargo test --package zjj-core --test jsonl_schema_validation_test -- --nocapture

================================================================================
FILES
================================================================================

Test file:
  /home/lewis/src/zjj/crates/zjj-core/tests/jsonl_schema_validation_test.rs

Detailed report:
  /home/lewis/src/zjj/JSONL_SCHEMA_VALIDATION_REPORT.md

CUE schemas:
  /home/lewis/src/zjj/.beads/beads/zjj-20260217-001-jsonl-core-types.cue
  /home/lewis/src/zjj/.beads/beads/zjj-20260217-002-jsonl-stack-queue-types.cue

Rust implementation:
  /home/lewis/src/zjj/crates/zjj-core/src/output/types.rs

================================================================================
